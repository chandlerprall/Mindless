<!DOCTYPE html><html><head><title>Lab 13</title><style>body {background:#222} canvas {display:block;margin:auto}</style></head><body><canvas id="c" width=640 height=480></canvas><script>
var l='length',p='prototype',sq=Math.sqrt // shortcuts

//Vector3
V3 = function( x, y, z ) {
	this.x = x || 0;
	this.y = y || 0;
	this.z = z || 0;
};
V3[p].set = function( x, y, z ) {
	this.x = x;
	this.y = y;
	this.z = z;
	return this;
};
V3[p].clone = function() {
	return new V3( this.x, this.y, this.z );
};
V3[p].sub = function( v ) {
	this.x -= v.x;
	this.y -= v.y;
	this.z -= v.z;
	return this;
};
V3[p].add = function( v ) {
	this.x += v.x;
	this.y += v.y;
	this.z += v.z;
	return this;
};
V3[p].cross = function( v ) {
	var x = this.x,
		y = this.y,
		z = this.z;

	this.x=y*v.z-z*v.y;
	this.y=z*v.x-x*v.z;
	this.z=x*v.y-y*v.x;
	return this;
};
V3[p].dot = function( v ) {
	return this.x * v.x + this.y * v.y + this.z * v.z;
};
V3[p].normalize = function() {
	var length = sq( this.x * this.x + this.y * this.y + this.z * this.z );

	this.x /= length;
	this.y /= length;
	this.z /= length;

	return this;
};
V3[p].length = function() {
	return sq( this.lengthSq() );
};
V3[p].lengthSq = function() {
	return this.x * this.x + this.y * this.y + this.z * this.z;
};
V3[p].copy = function( v ) {
	this.x = v.x;
	this.y = v.y;
	this.z = v.z;
	return this;
};
V3[p].getRotationFromMatrix = function( m ) {
	function clamp( x ) {

		return Math.min( Math.max( x, -1 ), 1 );

	}

	var te = m.e;
	var m11 = te[0], m12 = te[4], m13 = te[8];
	var m21 = te[1], m22 = te[5], m23 = te[9];
	var m31 = te[2], m32 = te[6], m33 = te[10];
	
	this.y = Math.asin( clamp( m13 ) );

	if ( Math.abs( m13 ) < 0.99999 ) {

		this.x = Math.atan2( - m23, m33 );
		this.z = Math.atan2( - m12, m11 );

	} else {

		this.x = Math.atan2( m21, m22 );
		this.z = 0;

	}
	
	return this;
};
V3[p].multiplyScalar = function( s ) {
	this.x *= s;
	this.y *= s;
	this.z *= s;

	return this;
};

//Matrix4
M4 = function( e ) {
	this.e = e || [1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]; // Matrix elements
};
M4[p].copy = function( m ) {
	var t1 = this.e, t2 = m.e;
	t1[0] = t2[0];
	t1[1] = t2[1];
	t1[2] = t2[2];
	t1[3] = t2[3];
	t1[4] = t2[4];
	t1[5] = t2[5];
	t1[6] = t2[6];
	t1[7] = t2[7];
	t1[8] = t2[8];
	t1[9] = t2[9];
	t1[10] = t2[10];
	t1[11] = t2[11];
	t1[12] = t2[12];
	t1[13] = t2[13];
	t1[14] = t2[14];
	t1[15] = t2[15];
};
M4[p].lookAt = function( t ) {
	var te = this.e;

	var x = v1;
	var y = v2;
	var z = v3;
	var up = new V3( 0, 1, 0 );

	z = this.getPosition().clone().sub( t ).normalize();

	if ( z.length() === 0 ) {

		z.z = 1;

	}

	x.copy( up ).cross( z ).normalize();
	
	if ( x.length() === 0 ) {

		z.x += 0.0001;
		x.copy( up ).cross( z ).normalize();

	}
	
	y.copy( z ).cross( x );

	te[0] = x.x; te[4] = y.x; te[8] = z.x;
	te[1] = x.y; te[5] = y.y; te[9] = z.y;
	te[2] = x.z; te[6] = y.z; te[10] = z.z;

	return this;
};
M4[p].getInverse = function( m ) {
	var te = this.e,
		me = m.e,

		n11 = me[0], n12 = me[4], n13 = me[8], n14 = me[12],
		n21 = me[1], n22 = me[5], n23 = me[9], n24 = me[13],
		n31 = me[2], n32 = me[6], n33 = me[10], n34 = me[14],
		n41 = me[3], n42 = me[7], n43 = me[11], n44 = me[15];

	te[0] = n23*n34*n42 - n24*n33*n42 + n24*n32*n43 - n22*n34*n43 - n23*n32*n44 + n22*n33*n44;
	te[4] = n14*n33*n42 - n13*n34*n42 - n14*n32*n43 + n12*n34*n43 + n13*n32*n44 - n12*n33*n44;
	te[8] = n13*n24*n42 - n14*n23*n42 + n14*n22*n43 - n12*n24*n43 - n13*n22*n44 + n12*n23*n44;
	te[12] = n14*n23*n32 - n13*n24*n32 - n14*n22*n33 + n12*n24*n33 + n13*n22*n34 - n12*n23*n34;
	te[1] = n24*n33*n41 - n23*n34*n41 - n24*n31*n43 + n21*n34*n43 + n23*n31*n44 - n21*n33*n44;
	te[5] = n13*n34*n41 - n14*n33*n41 + n14*n31*n43 - n11*n34*n43 - n13*n31*n44 + n11*n33*n44;
	te[9] = n14*n23*n41 - n13*n24*n41 - n14*n21*n43 + n11*n24*n43 + n13*n21*n44 - n11*n23*n44;
	te[13] = n13*n24*n31 - n14*n23*n31 + n14*n21*n33 - n11*n24*n33 - n13*n21*n34 + n11*n23*n34;
	te[2] = n22*n34*n41 - n24*n32*n41 + n24*n31*n42 - n21*n34*n42 - n22*n31*n44 + n21*n32*n44;
	te[6] = n14*n32*n41 - n12*n34*n41 - n14*n31*n42 + n11*n34*n42 + n12*n31*n44 - n11*n32*n44;
	te[10] = n12*n24*n41 - n14*n22*n41 + n14*n21*n42 - n11*n24*n42 - n12*n21*n44 + n11*n22*n44;
	te[14] = n14*n22*n31 - n12*n24*n31 - n14*n21*n32 + n11*n24*n32 + n12*n21*n34 - n11*n22*n34;
	te[3] = n23*n32*n41 - n22*n33*n41 - n23*n31*n42 + n21*n33*n42 + n22*n31*n43 - n21*n32*n43;
	te[7] = n12*n33*n41 - n13*n32*n41 + n13*n31*n42 - n11*n33*n42 - n12*n31*n43 + n11*n32*n43;
	te[11] = n13*n22*n41 - n12*n23*n41 - n13*n21*n42 + n11*n23*n42 + n12*n21*n43 - n11*n22*n43;
	te[15] = n12*n23*n31 - n13*n22*n31 + n13*n21*n32 - n11*n23*n32 - n12*n21*n33 + n11*n22*n33;
	this.multiplyScalar( 1 / m.determinant() );

	return this;
};
M4[p].multiplyScalar = function( s ) {
	var te = this.e;

	te[0] *= s; te[4] *= s; te[8] *= s; te[12] *= s;
	te[1] *= s; te[5] *= s; te[9] *= s; te[13] *= s;
	te[2] *= s; te[6] *= s; te[10] *= s; te[14] *= s;
	te[3] *= s; te[7] *= s; te[11] *= s; te[15] *= s;

	return this;
}
M4[p].determinant = function() {
	var te = this.e,

		n11 = te[0], n12 = te[4], n13 = te[8], n14 = te[12],
		n21 = te[1], n22 = te[5], n23 = te[9], n24 = te[13],
		n31 = te[2], n32 = te[6], n33 = te[10], n34 = te[14],
		n41 = te[3], n42 = te[7], n43 = te[11], n44 = te[15];

	return (
		n14 * n23 * n32 * n41-
		n13 * n24 * n32 * n41-
		n14 * n22 * n33 * n41+
		n12 * n24 * n33 * n41+

		n13 * n22 * n34 * n41-
		n12 * n23 * n34 * n41-
		n14 * n23 * n31 * n42+
		n13 * n24 * n31 * n42+

		n14 * n21 * n33 * n42-
		n11 * n24 * n33 * n42-
		n13 * n21 * n34 * n42+
		n11 * n23 * n34 * n42+

		n14 * n22 * n31 * n43-
		n12 * n24 * n31 * n43-
		n14 * n21 * n32 * n43+
		n11 * n24 * n32 * n43+

		n12 * n21 * n34 * n43-
		n11 * n22 * n34 * n43-
		n13 * n22 * n31 * n44+
		n12 * n23 * n31 * n44+

		n13 * n21 * n32 * n44-
		n11 * n23 * n32 * n44-
		n12 * n21 * n33 * n44+
		n11 * n22 * n33 * n44
	);
};
M4[p].multiply = function( a, b ) {
	var ae = a.e,
		be = b.e,
		te = this.e,

		a11 = ae[0], a12 = ae[4], a13 = ae[8], a14 = ae[12],
		a21 = ae[1], a22 = ae[5], a23 = ae[9], a24 = ae[13],
		a31 = ae[2], a32 = ae[6], a33 = ae[10], a34 = ae[14],
		a41 = ae[3], a42 = ae[7], a43 = ae[11], a44 = ae[15],

		b11 = be[0], b12 = be[4], b13 = be[8], b14 = be[12],
		b21 = be[1], b22 = be[5], b23 = be[9], b24 = be[13],
		b31 = be[2], b32 = be[6], b33 = be[10], b34 = be[14],
		b41 = be[3], b42 = be[7], b43 = be[11], b44 = be[15];

	te[0] = a11 * b11 + a12 * b21 + a13 * b31 + a14 * b41;
	te[4] = a11 * b12 + a12 * b22 + a13 * b32 + a14 * b42;
	te[8] = a11 * b13 + a12 * b23 + a13 * b33 + a14 * b43;
	te[12] = a11 * b14 + a12 * b24 + a13 * b34 + a14 * b44;

	te[1] = a21 * b11 + a22 * b21 + a23 * b31 + a24 * b41;
	te[5] = a21 * b12 + a22 * b22 + a23 * b32 + a24 * b42;
	te[9] = a21 * b13 + a22 * b23 + a23 * b33 + a24 * b43;
	te[13] = a21 * b14 + a22 * b24 + a23 * b34 + a24 * b44;

	te[2] = a31 * b11 + a32 * b21 + a33 * b31 + a34 * b41;
	te[6] = a31 * b12 + a32 * b22 + a33 * b32 + a34 * b42;
	te[10] = a31 * b13 + a32 * b23 + a33 * b33 + a34 * b43;
	te[14] = a31 * b14 + a32 * b24 + a33 * b34 + a34 * b44;

	te[3] = a41 * b11 + a42 * b21 + a43 * b31 + a44 * b41;
	te[7] = a41 * b12 + a42 * b22 + a43 * b32 + a44 * b42;
	te[11] = a41 * b13 + a42 * b23 + a43 * b33 + a44 * b43;
	te[15] = a41 * b14 + a42 * b24 + a43 * b34 + a44 * b44;

	return this;
};
M4[p].getMaxScaleOnAxis = function() {
	var te = this.e;

	var tx =  te[0] * te[0] + te[1] * te[1] + te[2] * te[2];
	var ty =  te[4] * te[4] + te[5] * te[5] + te[6] * te[6];
	var tz =  te[8] * te[8] + te[9] * te[9] + te[10] * te[10];

	return sq( Math.max( tx, Math.max( ty, tz ) ) );
};
M4[p].multiplyV3 = function( v ) {
	var te = this.e;

	var vx = v.x, vy = v.y, vz = v.z;
	var d = 1 / ( te[3] * vx + te[7] * vy + te[11] * vz + te[15] );

	v.x = ( te[0] * vx + te[4] * vy + te[8] * vz + te[12] ) * d;
	v.y = ( te[1] * vx + te[5] * vy + te[9] * vz + te[13] ) * d;
	v.z = ( te[2] * vx + te[6] * vy + te[10] * vz + te[14] ) * d;

	return v;
};
M4[p].multiplyV4 = function( v ) {
	var te = this.e;
	var vx = v.x, vy = v.y, vz = v.z, vw = v.w;

	v.x = te[0] * vx + te[4] * vy + te[8] * vz + te[12] * vw;
	v.y = te[1] * vx + te[5] * vy + te[9] * vz + te[13] * vw;
	v.z = te[2] * vx + te[6] * vy + te[10] * vz + te[14] * vw;
	v.w = te[3] * vx + te[7] * vy + te[11] * vz + te[15] * vw;

	return v;
};
M4[p].setPosition = function( v ) {
	var te = this.e;

	te[12] = v.x;
	te[13] = v.y;
	te[14] = v.z;

	return this;
};
var _gp1 = new V3;
M4[p].getPosition = function() {
	var te = this.e;
	return _gp1.set( te[12], te[13], te[14] );
};
M4[p].setRotation = function( v ) {
	var te = this.e;

	var x = v.x, y = v.y, z = v.z;
	var a = Math.cos( x ), b = Math.sin( x );
	var c = Math.cos( y ), d = Math.sin( y );
	var e = Math.cos( z ), f = Math.sin( z );
	
	var ae = a * e, af = a * f, be = b * e, bf = b * f;

	te[0] = c * e;
	te[4] = - c * f;
	te[8] = d;

	te[1] = af + be * d;
	te[5] = ae - bf * d;
	te[9] = - b * c;

	te[2] = bf - ae * d;
	te[6] = be + af * d;
	te[10] = a * c;
	
	return this;
};
M4[p].extractRotation = function( m ) {
	var te = this.e;
	var me = m.e;

	var vector = v1;

	var scaleX = 1 / vector.set( me[0], me[1], me[2] ).length();
	var scaleY = 1 / vector.set( me[4], me[5], me[6] ).length();
	var scaleZ = 1 / vector.set( me[8], me[9], me[10] ).length();

	te[0] = me[0] * scaleX;
	te[1] = me[1] * scaleX;
	te[2] = me[2] * scaleX;

	te[4] = me[4] * scaleY;
	te[5] = me[5] * scaleY;
	te[6] = me[6] * scaleY;

	te[8] = me[8] * scaleZ;
	te[9] = me[9] * scaleZ;
	te[10] = me[10] * scaleZ;

	return this;
};

//Vector4
V4 = function( x, y, z, w ) {
	this.x = x;
	this.y = y;
	this.z = z;
	this.w = w;
};
V4[p].set = function( x, y, z, w ) {
	this.x = x;
	this.y = y;
	this.z = z;
	this.w = w;
	return this;
};
V4[p].divideScalar = function( s ) {
	if ( s ) {
		this.x /= s;
		this.y /= s;
		this.z /= s;
		this.w /= s;
	} else {
		this.x = 0;
		this.y = 0;
		this.z = 0;
		this.w = 1;
	}
	return this;
};
V4[p].copy = function( v ) {
	this.x = v.x;
	this.y = v.y;
	this.z = v.z;
	this.w = ( v.w !== undefined ) ? v.w : 1;

	return this;
}
V4[p].clone = function( v ){
	return new V4( this.x, this.y, this.z, this.w );
}

//Frustum
FR = function() {
	this.planes = [ new V4, new V4, new V4, new V4, new V4, new V4 ];
};
FR[p].setFromMatrix = function( m ) {
	t1 = this.planes;
	var	me = m.e,
		me0 = me[0], me1 = me[1], me2 = me[2], me3 = me[3],
		me4 = me[4], me5 = me[5], me6 = me[6], me7 = me[7],
		me8 = me[8], me9 = me[9], me10 = me[10], me11 = me[11],
		me12 = me[12], me13 = me[13], me14 = me[14], me15 = me[15];

	t1[ 0 ].set( me3 - me0, me7 - me4, me11 - me8, me15 - me12 );
	t1[ 1 ].set( me3 + me0, me7 + me4, me11 + me8, me15 + me12 );
	t1[ 2 ].set( me3 + me1, me7 + me5, me11 + me9, me15 + me13 );
	t1[ 3 ].set( me3 - me1, me7 - me5, me11 - me9, me15 - me13 );
	t1[ 4 ].set( me3 - me2, me7 - me6, me11 - me10, me15 - me14 );
	t1[ 5 ].set( me3 + me2, me7 + me6, me11 + me10, me15 + me14 );

	for (i1=0;i1<6;i1++){
		t2 = t1[i1];
		t2.divideScalar( sq( t2.x * t2.x + t2.y * t2.y + t2.z * t2.z ) );
	}
};
FR[p].contains = function( o ) {
	t2 = this.planes;
	t3 = o.m.e;

	for ( var i2 = 0; i2 < 6; i2 ++ ) {
		t1 = t2[ i2 ].x * t3[12] + t2[ i2 ].y * t3[13] + t2[ i2 ].z * t3[14] + t2[ i2 ].w;
		if ( t1 <= - o.bs * o.m.getMaxScaleOnAxis() ) return false;
	}

	return true;
};

//Face
F = function( v, m, n ) {
	this.v=v; // list of V3s
	this.m=m; // material (V4)
	this.n=n; // F normal
};
F[p].clone = function() {
	return new F(
		[ this.v[0].clone(), this.v[1].clone(), this.v[2].clone() ],
		this.m.clone(),
		this.n.clone()
	)
};
F[p].computeW = function() {
	this.w = ( this.v[0].w + this.v[1].w + this.v[2].w ) / 3;
	return this;
};

Model = function( v, c, f ) {
	// vertices
	this.v = [];
	for ( i1 = 0; i1 < v[l]; i1 += 3 ) {
		this.v.push( new V3( v[i1], v[i1+1], v[i1+2] ) );
	}

	// materials
	this.c = [];
	for ( i1 = 0; i1 < c[l]; i1 += 4 ) {
		this.c.push( new V4( c[i1], c[i1+1], c[i1+2], c[i1+3] ) );
	}

	// faces
	this.f = [];
	for ( i1 = 0; i1 < f[l]; i1 += 4 ) {
		this.f.push( new F( [f[i1], f[i1+1], f[i1+2]], f[i1+3] ) );
	}

	this.m = new M4; //matrix
	this.p = new V3; //position
	this.r = new V3; //rotation
	this.t = new V3; //target, used for players
	this.k = []; //children
	this.a = []; //animation sets
	this.ap = []; //animation progress
	this.computeBoundingSphere();

	var i;
	for ( i = 0; i < this.f[l]; i++ ) {
		this.f[i].n = this.v[this.f[i].v[1]].clone().sub( this.v[this.f[i].v[0]] ).cross(
			this.v[this.f[i].v[2]].clone().sub( this.v[this.f[i].v[0]] )
		).normalize();
	}
};
Model[p].computeBoundingSphere = function() {
	var f, v, radius, maxRadius = 0;

	for ( f = 0; f < this.f[l]; f++ ) {
		for ( v = 0; v < this.f[f].v[l]; v++ ) {
			radius = this.v[this.f[f].v[v]][l]();
			if ( radius > maxRadius ) maxRadius = radius;
		}
	}
	this.boundingSphere = maxRadius;
}

var ca = document.getElementById('c'), c = ca.getContext('2d'),
b = 640, e = 480, //canvas width, height
w = window,
raf = 'equestAnimationFrame',
a = window['r'+raf] || window['mozR'+raf] || window['webkitR'+raf] || window['oR'+raf] || window['msR'+raf],

cam = {
	p: new M4( [1.6083801984786987,0,0,0,0,2.1445069313049316,0,0,0,0,-1.0002000331878662,-1,0,0,-2.000200033187866,0] ), //projection matrix
	m: new M4( [1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1] ), //world matrix
	i: new M4( [1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1] ), //matrix world inverse
	near: 1,
	far: 10000
},

scene_objects=[],
scene_renderables=[],
scene_elements=[],

map = [],
mapsize = 3, // map is 49x49

players = [],
player,

// Temporary variables
i1,i2,i3,
t1,t2,t3,
v1 = new V3, v2 = new V3, v3 = new V3, v4 = new V3,
v4_1 = new V4, v4_2 = new V4, v4_3 = new V4,
m1 = new M4,

run = function() {
	ca.addEventListener(
		'click',
		function( ev ) {
			var vector = new V3( ( ev.offsetX / b ) * 2 - 1, - ( ev.offsetY / e ) * 2 + 1, .5 );
			
			var test = new M4().getInverse( cam.p );
			var test2 = new M4().multiply( new M4().extractRotation( cam.m ), test );
			test2.multiplyV3( vector );
			vector.normalize();

			vector.multiplyScalar( -cam.m.getPosition().y / vector.y );
			vector.add( cam.m.getPosition().clone() );
			player.t.set( vector.x, 0, vector.z );
		}
	);
	anim();
},
anim = function() {
	// move players
	for ( i1 = 0; i1 < players[l]; i1++ ) {
		v1.copy( players[i1].t ).sub( players[i1].p );
		players[i1].p.x += Math.abs( v1.x ) > .01 ? .01 * (v1.x > 0 ? 1 : -1) : 0;
		players[i1].p.z += Math.abs( v1.z ) > .01 ? .01 * (v1.z > 0 ? 1 : -1) : 0;
	}
	
	player.ap[0] += .01;
	if ( player.ap[0] > 1 ) player.ap[0] = 0;
	
	// set camera position
	v1.copy( player.p ).add( v2.set( 5, 20, 5 ) );
	cam.m.setPosition( v1 );
	//cam.m.lookAt( player.p );
	render();
	a( anim ); // rAF loop
},
projectGraph = function() {
	scene_renderables[l] = 0;
	var o, c;
	for ( i1 = 0; i1 < scene_objects[l]; i1++ ){ //loop over all scene objects
		o = scene_objects[i1];
		o.m.setPosition( o.p );
		o.m.setRotation( o.r );
		if( FR.contains( o ) ) {
			v1.copy( o.m.getPosition() );
			projectionScreenMatrix.multiplyV3( v1 );
			o.d = v1.z;
			scene_renderables.push( o );
			
			for ( i2 = 0; i2 < o.k[l]; i2++ ) {
				c = o.k[i2]
				c.m.setPosition( c.p );
				c.m.setRotation( c.r );
				
				m1.multiply( o.m, c.m );
				c.m.copy( m1 );
				
				v1.copy( c.m.getPosition() );
				projectionScreenMatrix.multiplyV3( v1 );
				c.d = v1.z;
				scene_renderables.push( c );
			}
		}
	}
},
readyFaces = function() {
	scene_elements[l]=0;
	for( i1 = 0, t1 = scene_renderables[l]; i1 < t1; i1++ ) {
		t2 = scene_renderables[i1];
		m1.extractRotation(t2.m);
		
		var _vertices = [],
			visible;
		for ( i2 = 0; i2 < t2.f[l]; i2++ ) {
			// Move vertex to world position
			v1.copy( t2.v[ t2.f[i2].v[0] ] );
			v2.copy( t2.v[ t2.f[i2].v[1] ] );
			v3.copy( t2.v[ t2.f[i2].v[2] ] );
			
			// Apply animations
			for ( i3 = 0; i3 < t2.a[l]; i3++ ) {
				v4.set(
					t2.v[ t2.f[i2].v[0] ].x,
					t2.v[ t2.f[i2].v[0] ].y,
					t2.v[ t2.f[i2].v[0] ].z
				);
				v1.add( v4.multiplyScalar( t2.ap[i3] ) );

				v4.set(
					t2.v[ t2.f[i2].v[1] ].x,
					t2.v[ t2.f[i2].v[1] ].y,
					t2.v[ t2.f[i2].v[1] ].z
				);
				v2.add( v4.multiplyScalar( t2.ap[i3] ) );

				v4.set(
					t2.v[ t2.f[i2].v[2] ].x,
					t2.v[ t2.f[i2].v[2] ].y,
					t2.v[ t2.f[i2].v[2] ].z
				);
				v3.add( v4.multiplyScalar( t2.ap[i3] ) );
			}
			
			t2.m.multiplyV3( v1 );
			t2.m.multiplyV3( v2 );
			t2.m.multiplyV3( v3 );

			// Compute screen position
			v4_1.copy( v1 );
			v4_2.copy( v2 );
			v4_3.copy( v3 );

			projectionScreenMatrix.multiplyV4( v4_1 );
			projectionScreenMatrix.multiplyV4( v4_2 );
			projectionScreenMatrix.multiplyV4( v4_3 );

			v4_1.x /= v4_1.w;
			v4_1.y /= v4_1.w;
			//v4_1.visible = v4_1.z > near && v4_1.z < far;
			v4_2.x /= v4_2.w;
			v4_2.y /= v4_2.w;
			//v4_2.visible = v4_2.z > near && v4_2.z < far;
			v4_3.x /= v4_3.w;
			v4_3.y /= v4_3.w;
			//v4_3.visible = v4_3.z > near && v4_3.z < far;

			visible = ( ( v4_3.x - v4_1.x ) * ( v4_2.y - v4_1.y ) - ( v4_3.y - v4_1.y ) * ( v4_2.x - v4_1.x ) ) < 0;

			if (!visible) continue;

			v1.copy( t2.f[i2].n );
			m1.multiplyV3( v1 );
			scene_elements.push(
				new F(
					[ v4_1.clone(), v4_2.clone(), v4_3.clone() ],
					t2.c[ t2.f[i2].m ],
					v1.clone()
				).computeW()
			);
		}
	}
},
FSorter = function( a, b ) {
	return a.w < b.w;
},
expand = function( v1, v2 ) {
	// For dealing with canvas anti-aliasing
	var x = v2.x - v1.x, y =  v2.y - v1.y,
	det = x * x + y * y, idet;

	if ( det == 0 ) return;

	idet = 1 / Math.sqrt( det );

	x *= idet; y *= idet;

	v2.x += x; v2.y += y;
	v1.x -= x; v1.y -= y;
},
renderElements = function() {
	scene_elements.sort( FSorter );
	for( i1=0, t1 = scene_elements[l]; i1 < t1; i1++ ) {
		t2 = scene_elements[i1];

		t2.v[0].x *= 320; t2.v[0].y *= 240;
		t2.v[0].x += 320; t2.v[0].y += 240;

		t2.v[1].x *= 320; t2.v[1].y *= 240;
		t2.v[1].x += 320; t2.v[1].y += 240;

		t2.v[2].x *= 320; t2.v[2].y *= 240;
		t2.v[2].x += 320; t2.v[2].y += 240;

		var light_normal = new V3( 0,1,0 );
		var ambient_term = .3;
		light_value = Math.min( Math.max( light_normal.dot( t2.n ), 0 ) + ambient_term, 1 );
		
		// damn antialiasing
		expand( t2.v[0], t2.v[1] );
		expand( t2.v[1], t2.v[2] );
		expand( t2.v[2], t2.v[0] );
		
		c.fillStyle = 'rgba(' + Math.round( t2.m.x * light_value ) + ',' + Math.round( t2.m.y * light_value ) + ',' + Math.round( t2.m.z * light_value ) + ',' + t2.m.w + ')';
		c.beginPath();
		c.moveTo(t2.v[0].x,480-t2.v[0].y);
		c.lineTo(t2.v[1].x,480-t2.v[1].y);
		c.lineTo(t2.v[2].x,480-t2.v[2].y);
		c.lineTo(t2.v[0].x,480-t2.v[0].y);
		c.closePath();
		c.fill();
	}
},
FR = new FR,
projectionScreenMatrix = new M4, //projection screen matrix
prepareScene = function() {
	cam.i.getInverse( cam.m );
	projectionScreenMatrix.multiply( cam.p, cam.i );
	FR.setFromMatrix( projectionScreenMatrix );
	projectGraph();
},
render = function() {
	// clear the screen
	c.fillStyle = '#000';
	c.fillRect(0,0,b,e);
	prepareScene();
	readyFaces();
	renderElements();
},
title = function() {
	c.fillStyle = '#000';
	c.fillRect(0,0,b,e);
	c.font = '72pt Comic Sans';
	c.fillStyle = '#44dd77';
	c.fillText( 'Lab 13', 25, 100 );

	// Generate map array
	for ( i1 = 0; i1 < mapsize; i1++ ) {
		for ( i2 = 0; i2 < mapsize; i2++ ) {
			map[ i1 * mapsize + i2 ] = 0;
		}
	}

	// Ground
	scene_objects.push(
		new Model(
			[
				0, 0, 0,
				0, 0, mapsize,
				mapsize, 0, mapsize,
				mapsize, 0, 0 
			],
			[
				50, 50, 50, 1
			],
			[
				0, 1, 2, 0,
				2, 3, 0, 0
			]
		)
	);

	// Player's character
	player = new Model(
		[
			-.3, .1, -.3,
			-.3, .1, .3,
			.3, .1, .3,
			.3, .1, -.3
		],
		[
			255, 0, 0, 1
		],
		[
			0, 1, 2, 0,
			2, 3, 0, 0
		]
	);
	player.a.push([
		-.2, 0, -.2,
		-.2, 0, .2,
		.2, 0, .2,
		.2, 0, -.2
	]);
	player.ap.push(0);
	player.p.set( mapsize / 2, 0, mapsize / 2 );
	player.t.copy( player.p );
	players.push( player );
	scene_objects.push( player );


	c.font = '14pt Monospace';
	c.fillText( 'Click to start', 200, 200 );
	document.addEventListener(
		'click',
		function startGame() {
			document.removeEventListener( 'click', startGame );
			run();
		}
	);
};

cam.m.setPosition( new V3(mapsize / 2,30,mapsize/2) );
cam.m.setRotation( new V3(Math.PI / -2, 0, 0) );
title(); //start everything
</script></body></html>