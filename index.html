<!DOCTYPE html><html><head><title>Lab 13</title><style>body {background:#222} canvas {display:block;margin:auto}</style></head><body><canvas id="c" width=640 height=480></canvas><script>
var l='length',p='prototype',sq=Math.sqrt // shortcuts

//Vector3
V3 = function( x, y, z ) {
	this.x = x || 0;
	this.y = y || 0;
	this.z = z || 0;
};
V3[p].set = function( x, y, z ) {
	this.x = x;
	this.y = y;
	this.z = z;
	return this;
};
V3[p].clone = function() {
	return new V3( this.x, this.y, this.z );
};
V3[p].sub = function( v ) {
	this.x -= v.x;
	this.y -= v.y;
	this.z -= v.z;
	return this;
};
V3[p].add = function( v ) {
	this.x += v.x;
	this.y += v.y;
	this.z += v.z;
	return this;
};
V3[p].cross = function( v ) {
	var x = this.x,
		y = this.y,
		z = this.z;

	this.x=y*v.z-z*v.y;
	this.y=z*v.x-x*v.z;
	this.z=x*v.y-y*v.x;
	return this;
};
V3[p].dot = function( v ) {
	return this.x * v.x + this.y * v.y + this.z * v.z;
};
V3[p].normalize = function() {
	var length = sq( this.x * this.x + this.y * this.y + this.z * this.z );

	this.x /= length;
	this.y /= length;
	this.z /= length;

	return this;
};
V3[p].length = function() {
	return sq( this.lengthSq() );
};
V3[p].lengthSq = function() {
	return this.x * this.x + this.y * this.y + this.z * this.z;
};
V3[p].copy = function( v ) {
	this.x = v.x;
	this.y = v.y;
	this.z = v.z;
	return this;
};
V3[p].getRotationFromMatrix = function( m ) {
	function clamp( x ) {

		return Math.min( Math.max( x, -1 ), 1 );

	}

	var te = m.e;
	var m11 = te[0], m12 = te[4], m13 = te[8];
	var m21 = te[1], m22 = te[5], m23 = te[9];
	var m31 = te[2], m32 = te[6], m33 = te[10];
	
	this.y = Math.asin( clamp( m13 ) );

	if ( Math.abs( m13 ) < 0.99999 ) {

		this.x = Math.atan2( - m23, m33 );
		this.z = Math.atan2( - m12, m11 );

	} else {

		this.x = Math.atan2( m21, m22 );
		this.z = 0;

	}
	
	return this;
};
V3[p].multiplyScalar = function( s ) {
	this.x *= s;
	this.y *= s;
	this.z *= s;

	return this;
};

//Matrix4
M4 = function( e ) {
	this.e = e || [1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]; // Matrix elements
};
M4[p].copy = function( m ) {
	var t1 = this.e, t2 = m.e;
	t1[0] = t2[0];
	t1[1] = t2[1];
	t1[2] = t2[2];
	t1[3] = t2[3];
	t1[4] = t2[4];
	t1[5] = t2[5];
	t1[6] = t2[6];
	t1[7] = t2[7];
	t1[8] = t2[8];
	t1[9] = t2[9];
	t1[10] = t2[10];
	t1[11] = t2[11];
	t1[12] = t2[12];
	t1[13] = t2[13];
	t1[14] = t2[14];
	t1[15] = t2[15];
};
M4[p].lookAt = function( t ) {
	var te = this.e;

	var x = v1;
	var y = v2;
	var z = v3;
	var up = new V3( 0, 1, 0 );

	z = this.getPosition().clone().sub( t ).normalize();

	if ( z.length() === 0 ) {

		z.z = 1;

	}

	x.copy( up ).cross( z ).normalize();
	
	if ( x.length() === 0 ) {

		z.x += 0.0001;
		x.copy( up ).cross( z ).normalize();

	}
	
	y.copy( z ).cross( x );

	te[0] = x.x; te[4] = y.x; te[8] = z.x;
	te[1] = x.y; te[5] = y.y; te[9] = z.y;
	te[2] = x.z; te[6] = y.z; te[10] = z.z;

	return this;
};
M4[p].getInverse = function( m ) {
	var te = this.e,
		me = m.e,

		n11 = me[0], n12 = me[4], n13 = me[8], n14 = me[12],
		n21 = me[1], n22 = me[5], n23 = me[9], n24 = me[13],
		n31 = me[2], n32 = me[6], n33 = me[10], n34 = me[14],
		n41 = me[3], n42 = me[7], n43 = me[11], n44 = me[15];

	te[0] = n23*n34*n42 - n24*n33*n42 + n24*n32*n43 - n22*n34*n43 - n23*n32*n44 + n22*n33*n44;
	te[4] = n14*n33*n42 - n13*n34*n42 - n14*n32*n43 + n12*n34*n43 + n13*n32*n44 - n12*n33*n44;
	te[8] = n13*n24*n42 - n14*n23*n42 + n14*n22*n43 - n12*n24*n43 - n13*n22*n44 + n12*n23*n44;
	te[12] = n14*n23*n32 - n13*n24*n32 - n14*n22*n33 + n12*n24*n33 + n13*n22*n34 - n12*n23*n34;
	te[1] = n24*n33*n41 - n23*n34*n41 - n24*n31*n43 + n21*n34*n43 + n23*n31*n44 - n21*n33*n44;
	te[5] = n13*n34*n41 - n14*n33*n41 + n14*n31*n43 - n11*n34*n43 - n13*n31*n44 + n11*n33*n44;
	te[9] = n14*n23*n41 - n13*n24*n41 - n14*n21*n43 + n11*n24*n43 + n13*n21*n44 - n11*n23*n44;
	te[13] = n13*n24*n31 - n14*n23*n31 + n14*n21*n33 - n11*n24*n33 - n13*n21*n34 + n11*n23*n34;
	te[2] = n22*n34*n41 - n24*n32*n41 + n24*n31*n42 - n21*n34*n42 - n22*n31*n44 + n21*n32*n44;
	te[6] = n14*n32*n41 - n12*n34*n41 - n14*n31*n42 + n11*n34*n42 + n12*n31*n44 - n11*n32*n44;
	te[10] = n12*n24*n41 - n14*n22*n41 + n14*n21*n42 - n11*n24*n42 - n12*n21*n44 + n11*n22*n44;
	te[14] = n14*n22*n31 - n12*n24*n31 - n14*n21*n32 + n11*n24*n32 + n12*n21*n34 - n11*n22*n34;
	te[3] = n23*n32*n41 - n22*n33*n41 - n23*n31*n42 + n21*n33*n42 + n22*n31*n43 - n21*n32*n43;
	te[7] = n12*n33*n41 - n13*n32*n41 + n13*n31*n42 - n11*n33*n42 - n12*n31*n43 + n11*n32*n43;
	te[11] = n13*n22*n41 - n12*n23*n41 - n13*n21*n42 + n11*n23*n42 + n12*n21*n43 - n11*n22*n43;
	te[15] = n12*n23*n31 - n13*n22*n31 + n13*n21*n32 - n11*n23*n32 - n12*n21*n33 + n11*n22*n33;
	this.multiplyScalar( 1 / m.determinant() );

	return this;
};
M4[p].multiplyScalar = function( s ) {
	var te = this.e;

	te[0] *= s; te[4] *= s; te[8] *= s; te[12] *= s;
	te[1] *= s; te[5] *= s; te[9] *= s; te[13] *= s;
	te[2] *= s; te[6] *= s; te[10] *= s; te[14] *= s;
	te[3] *= s; te[7] *= s; te[11] *= s; te[15] *= s;

	return this;
}
M4[p].determinant = function() {
	var te = this.e,

		n11 = te[0], n12 = te[4], n13 = te[8], n14 = te[12],
		n21 = te[1], n22 = te[5], n23 = te[9], n24 = te[13],
		n31 = te[2], n32 = te[6], n33 = te[10], n34 = te[14],
		n41 = te[3], n42 = te[7], n43 = te[11], n44 = te[15];

	return (
		n14 * n23 * n32 * n41-
		n13 * n24 * n32 * n41-
		n14 * n22 * n33 * n41+
		n12 * n24 * n33 * n41+

		n13 * n22 * n34 * n41-
		n12 * n23 * n34 * n41-
		n14 * n23 * n31 * n42+
		n13 * n24 * n31 * n42+

		n14 * n21 * n33 * n42-
		n11 * n24 * n33 * n42-
		n13 * n21 * n34 * n42+
		n11 * n23 * n34 * n42+

		n14 * n22 * n31 * n43-
		n12 * n24 * n31 * n43-
		n14 * n21 * n32 * n43+
		n11 * n24 * n32 * n43+

		n12 * n21 * n34 * n43-
		n11 * n22 * n34 * n43-
		n13 * n22 * n31 * n44+
		n12 * n23 * n31 * n44+

		n13 * n21 * n32 * n44-
		n11 * n23 * n32 * n44-
		n12 * n21 * n33 * n44+
		n11 * n22 * n33 * n44
	);
};
M4[p].multiply = function( a, b ) {
	var ae = a.e,
		be = b.e,
		te = this.e,

		a11 = ae[0], a12 = ae[4], a13 = ae[8], a14 = ae[12],
		a21 = ae[1], a22 = ae[5], a23 = ae[9], a24 = ae[13],
		a31 = ae[2], a32 = ae[6], a33 = ae[10], a34 = ae[14],
		a41 = ae[3], a42 = ae[7], a43 = ae[11], a44 = ae[15],

		b11 = be[0], b12 = be[4], b13 = be[8], b14 = be[12],
		b21 = be[1], b22 = be[5], b23 = be[9], b24 = be[13],
		b31 = be[2], b32 = be[6], b33 = be[10], b34 = be[14],
		b41 = be[3], b42 = be[7], b43 = be[11], b44 = be[15];

	te[0] = a11 * b11 + a12 * b21 + a13 * b31 + a14 * b41;
	te[4] = a11 * b12 + a12 * b22 + a13 * b32 + a14 * b42;
	te[8] = a11 * b13 + a12 * b23 + a13 * b33 + a14 * b43;
	te[12] = a11 * b14 + a12 * b24 + a13 * b34 + a14 * b44;

	te[1] = a21 * b11 + a22 * b21 + a23 * b31 + a24 * b41;
	te[5] = a21 * b12 + a22 * b22 + a23 * b32 + a24 * b42;
	te[9] = a21 * b13 + a22 * b23 + a23 * b33 + a24 * b43;
	te[13] = a21 * b14 + a22 * b24 + a23 * b34 + a24 * b44;

	te[2] = a31 * b11 + a32 * b21 + a33 * b31 + a34 * b41;
	te[6] = a31 * b12 + a32 * b22 + a33 * b32 + a34 * b42;
	te[10] = a31 * b13 + a32 * b23 + a33 * b33 + a34 * b43;
	te[14] = a31 * b14 + a32 * b24 + a33 * b34 + a34 * b44;

	te[3] = a41 * b11 + a42 * b21 + a43 * b31 + a44 * b41;
	te[7] = a41 * b12 + a42 * b22 + a43 * b32 + a44 * b42;
	te[11] = a41 * b13 + a42 * b23 + a43 * b33 + a44 * b43;
	te[15] = a41 * b14 + a42 * b24 + a43 * b34 + a44 * b44;

	return this;
};
M4[p].getMaxScaleOnAxis = function() {
	var te = this.e;

	var tx =  te[0] * te[0] + te[1] * te[1] + te[2] * te[2];
	var ty =  te[4] * te[4] + te[5] * te[5] + te[6] * te[6];
	var tz =  te[8] * te[8] + te[9] * te[9] + te[10] * te[10];

	return sq( Math.max( tx, Math.max( ty, tz ) ) );
};
M4[p].multiplyV3 = function( v ) {
	var te = this.e;

	var vx = v.x, vy = v.y, vz = v.z;
	var d = 1 / ( te[3] * vx + te[7] * vy + te[11] * vz + te[15] );

	v.x = ( te[0] * vx + te[4] * vy + te[8] * vz + te[12] ) * d;
	v.y = ( te[1] * vx + te[5] * vy + te[9] * vz + te[13] ) * d;
	v.z = ( te[2] * vx + te[6] * vy + te[10] * vz + te[14] ) * d;

	return v;
};
M4[p].multiplyV4 = function( v ) {
	var te = this.e;
	var vx = v.x, vy = v.y, vz = v.z, vw = v.w;

	v.x = te[0] * vx + te[4] * vy + te[8] * vz + te[12] * vw;
	v.y = te[1] * vx + te[5] * vy + te[9] * vz + te[13] * vw;
	v.z = te[2] * vx + te[6] * vy + te[10] * vz + te[14] * vw;
	v.w = te[3] * vx + te[7] * vy + te[11] * vz + te[15] * vw;

	return v;
};
M4[p].setPosition = function( v ) {
	var te = this.e;

	te[12] = v.x;
	te[13] = v.y;
	te[14] = v.z;

	return this;
};
var _gp1 = new V3;
M4[p].getPosition = function() {
	var te = this.e;
	return _gp1.set( te[12], te[13], te[14] );
};
M4[p].setRotation = function( v ) {
	var te = this.e;

	var x = v.x, y = v.y, z = v.z;
	var a = Math.cos( x ), b = Math.sin( x );
	var c = Math.cos( y ), d = Math.sin( y );
	var e = Math.cos( z ), f = Math.sin( z );
	
	var ae = a * e, af = a * f, be = b * e, bf = b * f;

	te[0] = c * e;
	te[4] = - c * f;
	te[8] = d;

	te[1] = af + be * d;
	te[5] = ae - bf * d;
	te[9] = - b * c;

	te[2] = bf - ae * d;
	te[6] = be + af * d;
	te[10] = a * c;
	
	return this;
};
M4[p].extractRotation = function( m ) {
	var te = this.e;
	var me = m.e;

	var vector = v1;

	var scaleX = 1 / vector.set( me[0], me[1], me[2] ).length();
	var scaleY = 1 / vector.set( me[4], me[5], me[6] ).length();
	var scaleZ = 1 / vector.set( me[8], me[9], me[10] ).length();

	te[0] = me[0] * scaleX;
	te[1] = me[1] * scaleX;
	te[2] = me[2] * scaleX;

	te[4] = me[4] * scaleY;
	te[5] = me[5] * scaleY;
	te[6] = me[6] * scaleY;

	te[8] = me[8] * scaleZ;
	te[9] = me[9] * scaleZ;
	te[10] = me[10] * scaleZ;

	return this;
};

//Vector4
V4 = function( x, y, z, w ) {
	this.x = x;
	this.y = y;
	this.z = z;
	this.w = w;
};
V4[p].set = function( x, y, z, w ) {
	this.x = x;
	this.y = y;
	this.z = z;
	this.w = w;
	return this;
};
V4[p].divideScalar = function( s ) {
	if ( s ) {
		this.x /= s;
		this.y /= s;
		this.z /= s;
		this.w /= s;
	} else {
		this.x = 0;
		this.y = 0;
		this.z = 0;
		this.w = 1;
	}
	return this;
};
V4[p].copy = function( v ) {
	this.x = v.x;
	this.y = v.y;
	this.z = v.z;
	this.w = ( v.w !== undefined ) ? v.w : 1;

	return this;
}
V4[p].clone = function( v ){
	return new V4( this.x, this.y, this.z, this.w );
}

//Frustum
FR = function() {
	this.planes = [ new V4, new V4, new V4, new V4, new V4, new V4 ];
};
FR[p].setFromMatrix = function( m ) {
	t1 = this.planes;
	var	me = m.e,
		me0 = me[0], me1 = me[1], me2 = me[2], me3 = me[3],
		me4 = me[4], me5 = me[5], me6 = me[6], me7 = me[7],
		me8 = me[8], me9 = me[9], me10 = me[10], me11 = me[11],
		me12 = me[12], me13 = me[13], me14 = me[14], me15 = me[15];

	t1[ 0 ].set( me3 - me0, me7 - me4, me11 - me8, me15 - me12 );
	t1[ 1 ].set( me3 + me0, me7 + me4, me11 + me8, me15 + me12 );
	t1[ 2 ].set( me3 + me1, me7 + me5, me11 + me9, me15 + me13 );
	t1[ 3 ].set( me3 - me1, me7 - me5, me11 - me9, me15 - me13 );
	t1[ 4 ].set( me3 - me2, me7 - me6, me11 - me10, me15 - me14 );
	t1[ 5 ].set( me3 + me2, me7 + me6, me11 + me10, me15 + me14 );

	for (i1=0;i1<6;i1++){
		t2 = t1[i1];
		t2.divideScalar( sq( t2.x * t2.x + t2.y * t2.y + t2.z * t2.z ) );
	}
};
FR[p].contains = function( o ) {
	t2 = this.planes;
	t3 = o.m.e;

	for ( var i2 = 0; i2 < 6; i2 ++ ) {
		t1 = t2[ i2 ].x * t3[12] + t2[ i2 ].y * t3[13] + t2[ i2 ].z * t3[14] + t2[ i2 ].w;
		if ( t1 <= - o.bs * o.m.getMaxScaleOnAxis() ) return false;
	}

	return true;
};

//Face
F = function( v, m, n ) {
	this.v=v; // list of V3s
	this.m=m; // material (V4)
	this.n=n; // F normal
};
F[p].clone = function() {
	return new F(
		[ this.v[0].clone(), this.v[1].clone(), this.v[2].clone() ],
		this.m.clone(),
		this.n.clone(),
		this.c.clone()
	)
};
F[p].computeW = function() {
	this.w = ( this.v[0].w + this.v[1].w + this.v[2].w ) / 3;
	return this;
};

Geometry = function( v, f ) {
	// vertices
	this.v = [];
	for ( i1 = 0; i1 < v[l]; i1 += 3 ) {
		this.v.push( new V3( v[i1], v[i1+1], v[i1+2] ) );
	}

	// faces
	this.f = [];
	for ( i1 = 0; i1 < f[l]; i1 += 4 ) {
		this.f.push( new F( [f[i1], f[i1+1], f[i1+2]], f[i1+3] ) );
	}

	var i;
	for ( i = 0; i < this.f[l]; i++ ) {
		this.f[i].n = this.v[this.f[i].v[1]].clone().sub( this.v[this.f[i].v[0]] ).cross(
			this.v[this.f[i].v[2]].clone().sub( this.v[this.f[i].v[0]] )
		).normalize();
	}
};

Model = function( g, c ) {
	// materials
	this.c = [];
	for ( i1 = 0; i1 < c[l]; i1 += 4 ) {
		this.c.push( new V4( c[i1], c[i1+1], c[i1+2], c[i1+3] ) );
	}

	this.g = g; // geometry
	this.m = new M4; //matrix
	this.p = new V3; //position
	this.r = new V3; //rotation
	this.t = new V3; //target, used for players
	this.k = []; //children
	this.a = []; //animation sets
	this.ap = []; //animation progress
};

var ca = document.getElementById('c'), c = ca.getContext('2d'),
b = 640, e = 480, //canvas width, height
w = window,
raf = 'equestAnimationFrame',
a = window['r'+raf] || window['mozR'+raf] || window['webkitR'+raf] || window['oR'+raf] || window['msR'+raf],

cam = {
	p: new M4( [1.6083801984786987,0,0,0,0,2.1445069313049316,0,0,0,0,-1.0002000331878662,-1,0,0,-2.000200033187866,0] ), //projection matrix
	m: new M4( [1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1] ), //world matrix
	i: new M4( [1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1] ), //matrix world inverse
	near: 1,
	far: 10000
},

scene_objects=[],
scene_renderables=[],
scene_elements=[],

map = [],

materials = {
	floor_0: [ 35, 30, 25, 1 ],
	floor_1: [ 40, 35, 30, 1 ],
	floor_2: [ 35, 30, 35, 1 ],

	wall_0: [ 80, 70, 70, 1 ],
	wall_1: [ 85, 75, 70, 1 ],
	wall_2: [ 80, 75, 75, 1 ],

	player: [245,213,143,1,13,185,0,1,22,14,65,1,0,0,0,1]
},

animations = {
	person: [
		// Walking
		[-0.1415,0.4932,-0.2913,-0.1137,0.4941,-0.3037,-0.1278,0.4928,-0.2533,-0.1413,0.4922,-0.2352,-0.1279,0.4923,-0.1588,-0.1414,0.4921,-0.1767,-0.1139,0.4923,-0.1089,-0.1419,0.4926,-0.121,-0.0499,0.4931,-0.3038,-0.0332,0.4917,-0.2525,-0.0332,0.4912,-0.1579,-0.05,0.4911,-0.1089,0.0352,0.4915,-0.3037,0.023,0.4913,-0.2525,0.023,0.4909,-0.1579,0.0351,0.4895,-0.1089,0.098,0.4904,-0.3037,0.1129,0.4905,-0.2533,0.1127,0.4896,-0.1588,0.0979,0.4883,-0.1089,0.1268,0.4906,-0.2913,0.1271,0.4906,-0.2352,0.1269,0.4901,-0.1767,0.1264,0.4885,-0.121,-0.0453,1.1236,-0.1472,-0.0446,1.1245,-0.2518,-0.1241,1.1261,-0.2974,0.0574,1.1229,-0.2508,0.2146,1.109,-0.1072,0.0562,1.122,-0.1465,0.1514,1.1182,-0.2968,-0.2111,0.9139,-0.2757,-0.1935,0.9518,-0.1662,-0.2175,1.0033,-0.1221,-0.2035,1.1022,-0.1084,0.2143,0.9016,-0.128,0.2145,0.9039,-0.2692,-0.0381,0.2466,-0.3773,-0.0355,0.2484,-0.2958,-0.1165,0.2366,-0.2949,-0.1192,0.25,-0.3734,0.1129,0.2021,-0.1945,0.1126,0.2322,-0.1233,0.0327,0.2379,-0.1276,0.0332,0.196,-0.1915,-0.0445,0.0681,-0.3526,-0.1004,0.0675,-0.3524,-0.0436,0.0713,-0.2978,-0.0994,0.0697,-0.296,0.1024,0.0972,-0.0389,0.0477,0.0987,-0.0395,0.1021,0.1267,0.004,0.0473,0.1277,0.0012,-0.0471,0.0131,-0.2952,-0.0972,0.0119,-0.3,0.0997,0.0742,0.0322,0.0501,0.071,0.0292,-0.0723,0.018,-0.46,0.0752,0.0151,-0.122,-0.1982,0.6934,-0.0816,-0.2065,0.6748,-0.162,-0.2803,0.6989,-0.0743,-0.2887,0.6795,-0.1547,-0.247,0.9948,-0.2426,0.2179,0.6779,-0.2432,0.2126,0.6472,-0.1675,0.3003,0.6803,-0.2366,0.2945,0.6542,-0.1597,0.2419,0.9941,-0.2405,0.2459,0.9899,-0.1568,-0.2183,0.3637,-0.0021,-0.2901,0.3652,0.0031,-0.2982,0.3456,-0.0945,-0.2264,0.3427,-0.0993,0.2505,0.3776,-0.3965,0.3222,0.3782,-0.3897,0.3147,0.3356,-0.2997,0.243,0.3337,-0.3071,-0.0605,1.225,-0.1305,0.0558,1.1934,-0.1453,0.0585,1.1935,-0.2499,-0.043,1.1937,-0.2525,-0.0801,1.3985,-0.285,-0.05,1.3619,-0.2956,-0.05,1.3326,-0.2956,-0.0801,1.2639,-0.285,0.0374,1.3326,-0.2931,0.0714,1.3326,-0.2922,0.0714,1.3619,-0.2922,0.0977,1.3971,-0.281,0.0374,1.3619,-0.2931,-0.016,1.3326,-0.2946,-0.016,1.3619,-0.2946,0.0956,1.261,-0.2779,0.0928,1.3985,-0.1129,-0.0848,1.3985,-0.1179,0.0928,1.2639,-0.1129,0.0065,1.4411,-0.203,0.2177,1.0851,-0.2849,-0.2077,1.094,-0.2849]
	]
},

models = {
	person: new Geometry(
		[-0.1568,0.4884,-0.0375,-0.1301,0.4904,-0.0499,-0.1431,0.4876,0.0005,-0.1561,0.4864,0.0185,-0.1435,0.4879,0.095,-0.1564,0.4868,0.0771,-0.1305,0.4894,0.1449,-0.158,0.4897,0.1328,-0.0667,0.4871,-0.0499,-0.0452,0.4844,0.0011,-0.0452,0.484,0.0957,-0.0667,0.4855,0.1449,0.0182,0.4819,-0.05,0.0108,0.4832,0.0011,0.0108,0.4828,0.0957,0.0182,0.4803,0.1448,0.0812,0.4786,-0.05,0.0972,0.4803,0.0004,0.0968,0.4789,0.0949,0.0808,0.4764,0.1448,0.1111,0.4798,-0.0376,0.1119,0.4812,0.0185,0.1116,0.4802,0.077,0.1099,0.4764,0.1327,-0.0323,1.1168,0.1056,-0.0323,1.1174,0.001,-0.1118,1.1223,-0.0443,0.0696,1.1127,0.001,0.2261,1.0906,0.1453,0.0693,1.1115,0.1056,0.1632,1.1033,-0.0449,-0.2079,0.9164,-0.0222,-0.1928,0.9475,0.0953,-0.2118,1.0026,0.1311,-0.1919,1.1033,0.1443,0.2161,0.8834,0.1248,0.2163,0.8854,-0.0163,-0.0423,0.1822,0.0787,-0.043,0.2476,0.1256,-0.1236,0.2336,0.1363,-0.1236,0.1869,0.0762,0.11,0.2497,-0.1207,0.1085,0.2314,-0.0458,0.0285,0.2366,-0.0478,0.0306,0.2409,-0.1238,-0.0486,0.1064,0.2339,-0.1043,0.1014,0.2356,-0.049,0.1416,0.2675,-0.1047,0.1391,0.2702,0.1025,0.0662,-0.0603,0.0477,0.0669,-0.0603,0.1014,0.0731,-0.0058,0.0464,0.0728,-0.0081,-0.05,0.0788,0.2984,-0.1005,0.0836,0.3065,0.0995,0.0141,-0.0048,0.0498,0.0131,-0.0044,-0.0751,0.0198,0.1536,0.0749,0.0181,-0.1676,-0.2017,0.6672,0.0759,-0.1964,0.6912,-0.0014,-0.2841,0.6703,0.071,-0.2789,0.6912,-0.0076,-0.2374,1.0038,0.0099,0.2234,0.6459,0.028,0.2159,0.6371,0.1101,0.3055,0.6513,0.036,0.2978,0.6448,0.1182,0.2476,0.9741,0.0117,0.2511,0.9728,0.0951,-0.2068,0.3382,-0.05,-0.2786,0.3456,-0.0543,-0.2697,0.3854,-0.1454,-0.198,0.3768,-0.1416,0.2592,0.3099,-0.0244,0.3301,0.3184,-0.0153,0.3198,0.3046,0.083,0.2491,0.2952,0.0738,-0.0445,1.216,0.124,0.0712,1.1844,0.1057,0.071,1.1844,0.0011,-0.0305,1.185,0.0014,-0.0689,1.3896,-0.0298,-0.0391,1.3529,-0.0414,-0.0391,1.3236,-0.0414,-0.0689,1.2549,-0.0298,0.0483,1.3236,-0.0416,0.0823,1.3236,-0.0417,0.0823,1.3529,-0.0417,0.109,1.3882,-0.0313,0.0483,1.3529,-0.0416,-0.005,1.3236,-0.0415,-0.005,1.3529,-0.0415,0.107,1.2521,-0.0281,0.1092,1.3896,0.1369,-0.0685,1.3896,0.1373,0.1092,1.2549,0.1369,0.0202,1.4322,0.0494,0.2279,1.0662,-0.0324,-0.1966,1.0949,-0.0322],
		[0,1,2,0,2,3,0,0,3,2,4,0,4,5,3,0,5,4,6,0,6,7,5,0,1,8,9,0,9,2,1,0,4,10,11,0,11,6,4,0,8,12,13,0,13,9,8,0,9,13,14,0,14,10,9,0,10,14,15,0,15,11,10,0,12,16,17,0,17,13,12,0,14,18,19,0,19,15,14,0,16,20,21,0,21,17,16,0,17,21,22,0,22,18,17,0,18,22,23,0,23,19,18,0,24,25,26,1,26,25,27,1,28,29,24,1,27,29,30,1,0,3,31,1,3,5,32,1,5,7,33,1,7,6,34,1,6,11,28,1,11,15,28,1,15,19,28,1,19,23,35,1,23,22,35,1,22,21,36,1,21,20,36,1,20,16,30,1,16,12,26,1,12,8,26,1,8,1,26,1,1,0,31,1,2,9,37,2,9,10,38,2,10,4,39,2,4,2,40,2,13,17,41,2,17,18,42,2,18,14,43,2,14,13,44,2,45,46,40,2,47,45,37,2,48,47,38,2,46,48,39,2,49,50,44,2,51,49,41,2,52,51,42,2,50,52,43,2,45,47,53,0,47,48,54,0,48,46,54,0,49,51,55,0,51,52,56,0,52,50,56,0,46,45,57,0,50,49,58,0,59,60,31,1,61,59,32,1,62,61,33,1,60,62,63,1,64,65,35,1,66,64,36,1,67,66,68,1,65,67,69,1,60,59,70,0,59,61,71,0,61,62,72,0,62,60,73,0,65,64,74,0,64,66,75,0,66,67,76,0,67,65,77,0,25,24,78,0,24,29,79,0,29,27,80,0,27,25,81,0,82,83,84,0,85,86,87,0,87,88,89,0,89,88,90,0,88,87,86,3,86,90,88,3,85,91,86,0,89,90,92,0,90,86,91,0,91,92,90,0,85,84,91,0,82,92,83,0,92,91,84,3,84,83,92,3,38,39,48,2,37,40,2,2,39,38,10,2,40,37,45,2,40,39,4,2,39,40,46,2,37,38,47,2,38,37,9,2,43,42,18,2,44,41,49,2,42,43,52,2,41,44,13,2,43,44,50,2,44,43,14,2,41,42,51,2,42,41,17,2,28,34,6,1,27,30,26,1,28,24,26,1,26,30,16,1,79,78,24,0,80,79,29,0,93,87,89,0,92,82,89,0,85,82,84,0,94,95,78,0,36,35,22,1,36,68,66,1,28,30,29,1,35,36,64,1,32,31,3,1,31,32,59,1,33,63,62,1,26,34,28,1,96,93,89,0,94,89,97,0,81,80,27,0,87,93,85,0,35,28,19,1,28,69,98,1,85,78,95,0,78,81,25,0,45,53,57,0,54,46,57,0,49,55,58,0,56,50,58,0,70,73,60,0,72,71,61,0,74,77,65,0,76,75,66,0,63,33,99,1,31,26,1,1,89,82,97,0,85,95,82,0,98,68,36,1,30,36,20,1,34,33,7,1,34,99,33,1,69,28,35,1,69,35,65,1,78,96,94,0,96,89,94,0,95,94,97,0,82,95,97,0,53,54,57,0,54,53,47,0,56,55,51,0,55,56,58,0,33,32,5,1,32,33,61,1,63,31,60,1,63,99,31,1,71,70,59,0,73,70,71,0,71,72,73,0,73,72,62,0,77,74,75,0,75,74,64,0,77,76,67,0,75,76,77,0,68,69,67,1,69,68,98,1,26,31,99,1,34,26,99,1,30,98,36,1,28,98,30,1,78,85,81,0,80,81,85,0,93,96,79,0,78,79,96,0,79,80,93,0,80,85,93,0]
	),
	tile: new Geometry(
			[
				-4.7,0,-4.7,
				4.7,0,-4.7,
				4.7,0,4.7,
				-4.7,0,4.7
			],
			[
				2,1,0,0,
				3,2,0,0
			]
		),
	wall: new Geometry(
			[
				-5,10,-5,
				5,10,-5,
				5,0,-5,
				-5,0,-5
			],
			[
				2,1,0,0,
				3,2,0,0
			]
		)
},

players = [],
player,

// Temporary variables
i1,i2,i3,
t1,t2,t3,
v1 = new V3, v2 = new V3, v3 = new V3, v4 = new V3,
v4_1 = new V4, v4_2 = new V4, v4_3 = new V4,
m1 = new M4,

run = function() {
	ca.addEventListener(
		'click',
		function( ev ) {
			var vector = new V3(
				( (ev.clientX - ca.offsetLeft) / b ) * 2 - 1,
				- ( (ev.clientY - ca.offsetTop) / e ) * 2 + 1,
				.5
			);
			
			var test = new M4().getInverse( cam.p );
			var test2 = new M4().multiply( new M4().extractRotation( cam.m ), test );
			test2.multiplyV3( vector );
			vector.normalize();

			vector.multiplyScalar( -cam.m.getPosition().y / vector.y );
			vector.add( cam.m.getPosition().clone() );
			player.t.set( vector.x, 0, vector.z );
		}
	);
	anim();
},
anim = function() {
	// move players
	for ( i1 = 0; i1 < players[l]; i1++ ) {
		v1.copy( players[i1].t ).sub( players[i1].p );

		if ( Math.abs( v1.x ) > .2 || Math.abs( v1.z ) > .2 ) {
			v2.copy( players[i1].p )
			v2.x += Math.abs( v1.x ) > .2 ? .2 * (v1.x > 0 ? 1 : -1) : 0;
			v2.z += Math.abs( v1.z ) > .2 ? .2 * (v1.z > 0 ? 1 : -1) : 0;
			

			// Check map bounds
			if (
				v2.x < 0 || v2.z < 0 || v2.x / 10 > map[0][l] - 1 || v2.z / 10 > map[l] - 1 // Map edges
				||
				map[Math.round( v2.z / 10 )][Math.round( v2.x / 10 )] === 0
			) {
				continue;
			}
			
			players[i1].p.x = v2.x;
			players[i1].p.z = v2.z;
			players[i1].m.lookAt( v2 );
			players[i1].r.getRotationFromMatrix( players[i1].m );

			if ( !players[i1].a_desc ) {
				players[i1].ap[0] += 0.06;
				if ( players[i1].ap[0] > 1 ) players[i1].a_desc = true;
			} else {
				players[i1].ap[0] -= 0.06;
				if ( players[i1].ap[0] < 0 ) players[i1].a_desc = false;
			}
		}
	}
	

	// set camera position
	v1.copy( player.p ).add( v2.set( 30, 70, 90 ) );
	cam.m.setPosition( v1 );
	cam.m.lookAt( player.p );
	render();
	a( anim ); // rAF loop
},
projectGraph = function() {
	scene_renderables[l] = 0;
	var o, c;
	for ( i1 = 0; i1 < scene_objects[l]; i1++ ){ //loop over all scene objects
		o = scene_objects[i1];
		o.m.setPosition( o.p );
		o.m.setRotation( o.r );
		if( FR.contains( o ) ) {
			v1.copy( o.m.getPosition() );
			projectionScreenMatrix.multiplyV3( v1 );
			scene_renderables.push( o );
			
			for ( i2 = 0; i2 < o.k[l]; i2++ ) {
				c = o.k[i2]
				c.m.setPosition( c.p );
				c.m.setRotation( c.r );
				
				m1.multiply( o.m, c.m );
				c.m.copy( m1 );
				
				v1.copy( c.m.getPosition() );
				projectionScreenMatrix.multiplyV3( v1 );
				scene_renderables.push( c );
			}
		}
	}
},
readyFaces = function() {
	scene_elements[l]=0;
	for( i1 = 0, t1 = scene_renderables[l]; i1 < t1; i1++ ) {

		t2 = scene_renderables[i1];
		m1.extractRotation(t2.m);
		
		if ( !isVisible( player.p, t2.p ) ) continue;

		var _vertices = [],
			visible;
		for ( i2 = 0; i2 < t2.g.f[l]; i2++ ) {
			// Move vertex to world position
			v1.copy( t2.g.v[ t2.g.f[i2].v[0] ] );
			v2.copy( t2.g.v[ t2.g.f[i2].v[1] ] );
			v3.copy( t2.g.v[ t2.g.f[i2].v[2] ] );
			
			// Apply animations
			for ( i3 = 0; i3 < t2.a[l]; i3++ ) {
				v4.set(
					t2.a[i3][ t2.g.f[i2].v[0] * 3 ],
					t2.a[i3][ t2.g.f[i2].v[0] * 3 + 1 ],
					t2.a[i3][ t2.g.f[i2].v[0] * 3 + 2 ]
				);
				v1.add( v4.multiplyScalar( t2.ap[i3] ) );

				v4.set(
					t2.a[i3][ t2.g.f[i2].v[1] * 3 ],
					t2.a[i3][ t2.g.f[i2].v[1] * 3 + 1 ],
					t2.a[i3][ t2.g.f[i2].v[1] * 3 + 2 ]
				);
				v2.add( v4.multiplyScalar( t2.ap[i3] ) );

				v4.set(
					t2.a[i3][ t2.g.f[i2].v[2] * 3 ],
					t2.a[i3][ t2.g.f[i2].v[2] * 3 + 1 ],
					t2.a[i3][ t2.g.f[i2].v[2] * 3 + 2 ]
				);
				v3.add( v4.multiplyScalar( t2.ap[i3] ) );
			}
			
			t2.m.multiplyV3( v1 );
			t2.m.multiplyV3( v2 );
			t2.m.multiplyV3( v3 );

			// Compute screen position
			v4_1.copy( v1 );
			v4_2.copy( v2 );
			v4_3.copy( v3 );

			projectionScreenMatrix.multiplyV4( v4_1 );
			projectionScreenMatrix.multiplyV4( v4_2 );
			projectionScreenMatrix.multiplyV4( v4_3 );

			v4_1.x /= v4_1.w;
			v4_1.y /= v4_1.w;
			//v4_1.visible = v4_1.z > near && v4_1.z < far;
			v4_2.x /= v4_2.w;
			v4_2.y /= v4_2.w;
			//v4_2.visible = v4_2.z > near && v4_2.z < far;
			v4_3.x /= v4_3.w;
			v4_3.y /= v4_3.w;
			//v4_3.visible = v4_3.z > near && v4_3.z < far;

			visible = ( ( v4_3.x - v4_1.x ) * ( v4_2.y - v4_1.y ) - ( v4_3.y - v4_1.y ) * ( v4_2.x - v4_1.x ) ) < 0;

			if (!visible) continue;

			v1.copy( t2.g.f[i2].n );
			m1.multiplyV3( v1 );
			
			t3 = new F(
				[ v4_1.clone(), v4_2.clone(), v4_3.clone() ],
				t2.c[ t2.g.f[i2].m ],
				v1.clone()
			).computeW();

			scene_elements.push( t3 );
		}
	}
}
FSorter = function( a, b ) {
	//return b.c.z - a.c.z;
	return b.w - a.w;
},
expand = function( v1, v2 ) {
	// For dealing with canvas anti-aliasing
	var x = v2.x - v1.x, y =  v2.y - v1.y,
	det = x * x + y * y, idet;

	if ( det == 0 ) return;

	idet = 1 / Math.sqrt( det );

	x *= idet; y *= idet;

	v2.x += x; v2.y += y;
	v1.x -= x; v1.y -= y;
},
createPerson = function( type ) {
	var person = new Model(
		models.person,
		materials[type]
	);
	person.ap[0] = 0;
	person.a = animations.person;
	if ( !window.fixed_anim ) {
		for ( i1 = 0; i1 < person.g.v[l]; i1++ ) {
			person.g.v[i1].multiplyScalar( 10 );

			person.a[0][i1 * 3] *= 10;
			person.a[0][i1 * 3 + 1] *= 10;
			person.a[0][i1 * 3 + 2] *= 10;

			person.a[0][i1 * 3] -= person.g.v[i1].x;
			person.a[0][i1 * 3 + 1] -= person.g.v[i1].y;
			person.a[0][i1 * 3 + 2] -= person.g.v[i1].z;
		}
		window.fixed_anim = true;
	}
	return person;
};
renderElements = function() {
	scene_elements.sort( FSorter );
	for( i1=0, t1 = scene_elements[l]; i1 < t1; i1++ ) {
		t2 = scene_elements[i1];

		t2.v[0].x *= 320; t2.v[0].y *= 240;
		t2.v[0].x += 320; t2.v[0].y += 240;

		t2.v[1].x *= 320; t2.v[1].y *= 240;
		t2.v[1].x += 320; t2.v[1].y += 240;

		t2.v[2].x *= 320; t2.v[2].y *= 240;
		t2.v[2].x += 320; t2.v[2].y += 240;

		var light_normal = new V3( .2,.8,.6 ).normalize();
		var ambient_term = .3;
		light_value = Math.min( Math.max( light_normal.dot( t2.n ), 0 ) + ambient_term, 1 );
		
		// damn antialiasing
		expand( t2.v[0], t2.v[1] );
		expand( t2.v[1], t2.v[2] );
		expand( t2.v[2], t2.v[0] );
		
		c.fillStyle = 'rgba(' + Math.round( t2.m.x * light_value ) + ',' + Math.round( t2.m.y * light_value ) + ',' + Math.round( t2.m.z * light_value ) + ',' + t2.m.w + ')';
		c.beginPath();
		c.moveTo(t2.v[0].x,480-t2.v[0].y);
		c.lineTo(t2.v[1].x,480-t2.v[1].y);
		c.lineTo(t2.v[2].x,480-t2.v[2].y);
		c.lineTo(t2.v[0].x,480-t2.v[0].y);
		c.closePath();
		c.fill();
	}
},
isVisible = function( eye, point ) {
	var i1, i2, distance;
	// Walk on the map from eye to point
	v1.copy( point ).sub( eye ); // eye vector
	distance = v1.length();

	v1.normalize();

	v2.copy( eye ); // v2 holds the current position on the map to check
	for ( i1 = 0; i1 < distance - 1; i1++ ) {
		if (map[ Math.round( v2.z / 10 ) ] !== undefined && map[ Math.round( v2.z / 10 ) ][ Math.round( v2.x / 10 ) ] !== undefined ) {
			if ( map[ Math.round( v2.z / 10 ) ][ Math.round( v2.x / 10 ) ] === 0 ) {
				return false;
			}
		}
		v2.add( v1 );
	}

	return true;
},
FR = new FR,
projectionScreenMatrix = new M4, //projection screen matrix
prepareScene = function() {
	cam.i.getInverse( cam.m );
	projectionScreenMatrix.multiply( cam.p, cam.i );
	FR.setFromMatrix( projectionScreenMatrix );
	projectGraph();
},
render = function() {
	// clear the screen
	c.fillStyle = '#000';
	c.fillRect(0,0,b,e);
	prepareScene();
	readyFaces();
	renderElements();
},
title = function() {
	c.fillStyle = '#000';
	c.fillRect(0,0,b,e);
	c.font = '72pt Comic Sans';
	c.fillStyle = '#44dd77';
	c.fillText( 'Lab 13', 25, 100 );

	var i1, i2, i3, drawRoom = function( x1, y1, x2, y2, options ) {
		options = options || {};

		var person, people = [];

		// Create tiles
		for ( i1 = y1; i1 <= y2; i1++ ) {
			for ( i2 = x1; i2 <= x2; i2++ ) {
				map[i1][i2] = 1;
			}
		}

		// Populate
		if ( options.pmin > 0 && options.pmax ) {
			t1 = Math.floor( Math.random() * (options.pmax - options.pmin + 1) ) + options.pmin;
			for ( i1 = 0; i1 < t1; i1++ ) {
				person = createPerson( 'player' );
				person.p.set(
					( (Math.random() * (x2 - x1)) + x1 ) * 10,
					0,
					( (Math.random() * (y2 - y1)) + y1 ) * 10
				);
				person.t.set(
					( (Math.random() * (x2 - x1)) + x1 ) * 10,
					0,
					( (Math.random() * (y2 - y1)) + y1 ) * 10
				);
				players.push( person );
				scene_objects.push( person );
			}
		}
	};

	// Generate map
	for ( i1 = 0; i1 < 50; i1++ ) {
		map[i1] = [];
		for ( i2 = 0; i2 < 50; i2++ ) {
			map[i1][i2] = 0;
		}
	}

	drawRoom( 0, 10, 8, 14 );
	drawRoom( 8, 11, 16, 13, {pmin: 4, pmax:7} );
	drawRoom( 12, 10, 12, 10 );
	drawRoom( 10, 6, 14, 9, {pmin: 2, pmax:3} );

	for ( i1 = 0; i1 < map[0][l]; i1++ ) {
		for ( i2 = 0; i2 < map[l]; i2++ ) {
			// Floor
			switch ( map[i2][i1] ) {
				case 1:
					t1 = new Model( models.tile, materials['floor_' + Math.floor( Math.random() * 3 ) ] );
					t1.p.set( i1 * 10, 0, i2 * 10 );
					scene_objects.push( t1 );
					break;
			}

			// Wall
			if ( map[i2][i1] !== 0 ) {
				if ( map[i2 - 1] === undefined || map[i2 - 1][i1] === 0 ) {
					// Need a wall on top
					t1 = new Model( models.wall, materials['wall_' + Math.floor( Math.random() * 3 ) ] );
					t1.p.set( i1 * 10, 0, i2 * 10 );
					scene_objects.push( t1 );
				}

				if ( map[i2 + 1] === undefined || map[i2 + 1][i1] === 0 ) {
					// Need a wall on bottom
					t1 = new Model( models.wall, materials['wall_' + Math.floor( Math.random() * 3 ) ] );
					t1.p.set( i1 * 10, 0, i2 * 10 );
					t1.r.set( 0, Math.PI, 0 )
					scene_objects.push( t1 );
				}
				
				if ( map[i2][i1 - 1] === undefined || map[i2][i1 - 1] === 0 ) {
					// Need a wall on left
					t1 = new Model( models.wall, materials['wall_' + Math.floor( Math.random() * 3 ) ] );
					t1.p.set( i1 * 10, 0, i2 * 10 );
					t1.r.set( 0, Math.PI / 2, 0 )
					scene_objects.push( t1 );
				}
				
				if ( map[i2][i1 + 1] === undefined || map[i2][i1 + 1] === 0 ) {
					// Need a wall on right
					t1 = new Model( models.wall, materials['wall_' + Math.floor( Math.random() * 3 ) ] );
					t1.p.set( i1 * 10, 0, i2 * 10 );
					t1.r.set( 0, Math.PI / -2, 0 )
					scene_objects.push( t1 );
				}
			}
		}
	}

	player = createPerson( 'player' );
	player.p.set( 30, 0, 120 );
	player.t.copy( player.p );
	players.push( player );
	scene_objects.push( player );

	c.font = '14pt Monospace';
	c.fillText( 'Click to start', 200, 200 );
	document.addEventListener(
		'click',
		function startGame() {
			document.removeEventListener( 'click', startGame );
			run();
		}
	);
};
title(); //start everything
</script></body></html>