<!DOCTYPE html><html><head><title>Lab 13</title><style>body {background:#222} canvas {display:block;margin:auto}</style></head><body><canvas id="c" width=640 height=480></canvas><script>
var l='length',p='prototype',sq=Math.sqrt // shortcuts

//Vector3
V3 = function( x, y, z ) {
	this.x = x || 0;
	this.y = y || 0;
	this.z = z || 0;
};
V3[p].set = function( x, y, z ) {
	this.x = x;
	this.y = y;
	this.z = z;
	return this;
};
V3[p].clone = function() {
	return new V3( this.x, this.y, this.z );
};
V3[p].sub = function( v ) {
	this.x -= v.x;
	this.y -= v.y;
	this.z -= v.z;
	return this;
};
V3[p].add = function( v ) {
	this.x += v.x;
	this.y += v.y;
	this.z += v.z;
	return this;
};
V3[p].cross = function( v ) {
	var x = this.x,
		y = this.y,
		z = this.z;

	this.x=y*v.z-z*v.y;
	this.y=z*v.x-x*v.z;
	this.z=x*v.y-y*v.x;
	return this;
};
V3[p].dot = function( v ) {
	return this.x * v.x + this.y * v.y + this.z * v.z;
};
V3[p].normalize = function() {
	var length = sq( this.x * this.x + this.y * this.y + this.z * this.z );

	this.x /= length;
	this.y /= length;
	this.z /= length;

	return this;
};
V3[p].length = function() {
	return sq( this.lengthSq() );
};
V3[p].lengthSq = function() {
	return this.x * this.x + this.y * this.y + this.z * this.z;
};
V3[p].copy = function( v ) {
	this.x = v.x;
	this.y = v.y;
	this.z = v.z;
	return this;
};
V3[p].getRotationFromMatrix = function( m ) {
	function clamp( x ) {

		return Math.min( Math.max( x, -1 ), 1 );

	}

	var te = m.e;
	var m11 = te[0], m12 = te[4], m13 = te[8];
	var m21 = te[1], m22 = te[5], m23 = te[9];
	var m31 = te[2], m32 = te[6], m33 = te[10];
	
	this.y = Math.asin( clamp( m13 ) );

	if ( Math.abs( m13 ) < 0.99999 ) {

		this.x = Math.atan2( - m23, m33 );
		this.z = Math.atan2( - m12, m11 );

	} else {

		this.x = Math.atan2( m21, m22 );
		this.z = 0;

	}
	
	return this;
};
V3[p].multiplyScalar = function( s ) {
	this.x *= s;
	this.y *= s;
	this.z *= s;

	return this;
};

//Matrix4
M4 = function( e ) {
	this.e = e || [1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]; // Matrix elements
};
M4[p].copy = function( m ) {
	var t1 = this.e, t2 = m.e;
	t1[0] = t2[0];
	t1[1] = t2[1];
	t1[2] = t2[2];
	t1[3] = t2[3];
	t1[4] = t2[4];
	t1[5] = t2[5];
	t1[6] = t2[6];
	t1[7] = t2[7];
	t1[8] = t2[8];
	t1[9] = t2[9];
	t1[10] = t2[10];
	t1[11] = t2[11];
	t1[12] = t2[12];
	t1[13] = t2[13];
	t1[14] = t2[14];
	t1[15] = t2[15];
};
M4[p].lookAt = function( t ) {
	var te = this.e;

	var x = v1;
	var y = v2;
	var z = v3;
	var up = new V3( 0, 1, 0 );

	z = this.getPosition().clone().sub( t ).normalize();

	if ( z.length() === 0 ) {

		z.z = 1;

	}

	x.copy( up ).cross( z ).normalize();
	
	if ( x.length() === 0 ) {

		z.x += 0.0001;
		x.copy( up ).cross( z ).normalize();

	}
	
	y.copy( z ).cross( x );

	te[0] = x.x; te[4] = y.x; te[8] = z.x;
	te[1] = x.y; te[5] = y.y; te[9] = z.y;
	te[2] = x.z; te[6] = y.z; te[10] = z.z;

	return this;
};
M4[p].getInverse = function( m ) {
	var te = this.e,
		me = m.e,

		n11 = me[0], n12 = me[4], n13 = me[8], n14 = me[12],
		n21 = me[1], n22 = me[5], n23 = me[9], n24 = me[13],
		n31 = me[2], n32 = me[6], n33 = me[10], n34 = me[14],
		n41 = me[3], n42 = me[7], n43 = me[11], n44 = me[15];

	te[0] = n23*n34*n42 - n24*n33*n42 + n24*n32*n43 - n22*n34*n43 - n23*n32*n44 + n22*n33*n44;
	te[4] = n14*n33*n42 - n13*n34*n42 - n14*n32*n43 + n12*n34*n43 + n13*n32*n44 - n12*n33*n44;
	te[8] = n13*n24*n42 - n14*n23*n42 + n14*n22*n43 - n12*n24*n43 - n13*n22*n44 + n12*n23*n44;
	te[12] = n14*n23*n32 - n13*n24*n32 - n14*n22*n33 + n12*n24*n33 + n13*n22*n34 - n12*n23*n34;
	te[1] = n24*n33*n41 - n23*n34*n41 - n24*n31*n43 + n21*n34*n43 + n23*n31*n44 - n21*n33*n44;
	te[5] = n13*n34*n41 - n14*n33*n41 + n14*n31*n43 - n11*n34*n43 - n13*n31*n44 + n11*n33*n44;
	te[9] = n14*n23*n41 - n13*n24*n41 - n14*n21*n43 + n11*n24*n43 + n13*n21*n44 - n11*n23*n44;
	te[13] = n13*n24*n31 - n14*n23*n31 + n14*n21*n33 - n11*n24*n33 - n13*n21*n34 + n11*n23*n34;
	te[2] = n22*n34*n41 - n24*n32*n41 + n24*n31*n42 - n21*n34*n42 - n22*n31*n44 + n21*n32*n44;
	te[6] = n14*n32*n41 - n12*n34*n41 - n14*n31*n42 + n11*n34*n42 + n12*n31*n44 - n11*n32*n44;
	te[10] = n12*n24*n41 - n14*n22*n41 + n14*n21*n42 - n11*n24*n42 - n12*n21*n44 + n11*n22*n44;
	te[14] = n14*n22*n31 - n12*n24*n31 - n14*n21*n32 + n11*n24*n32 + n12*n21*n34 - n11*n22*n34;
	te[3] = n23*n32*n41 - n22*n33*n41 - n23*n31*n42 + n21*n33*n42 + n22*n31*n43 - n21*n32*n43;
	te[7] = n12*n33*n41 - n13*n32*n41 + n13*n31*n42 - n11*n33*n42 - n12*n31*n43 + n11*n32*n43;
	te[11] = n13*n22*n41 - n12*n23*n41 - n13*n21*n42 + n11*n23*n42 + n12*n21*n43 - n11*n22*n43;
	te[15] = n12*n23*n31 - n13*n22*n31 + n13*n21*n32 - n11*n23*n32 - n12*n21*n33 + n11*n22*n33;
	this.multiplyScalar( 1 / m.determinant() );

	return this;
};
M4[p].multiplyScalar = function( s ) {
	var te = this.e;

	te[0] *= s; te[4] *= s; te[8] *= s; te[12] *= s;
	te[1] *= s; te[5] *= s; te[9] *= s; te[13] *= s;
	te[2] *= s; te[6] *= s; te[10] *= s; te[14] *= s;
	te[3] *= s; te[7] *= s; te[11] *= s; te[15] *= s;

	return this;
}
M4[p].determinant = function() {
	var te = this.e,

		n11 = te[0], n12 = te[4], n13 = te[8], n14 = te[12],
		n21 = te[1], n22 = te[5], n23 = te[9], n24 = te[13],
		n31 = te[2], n32 = te[6], n33 = te[10], n34 = te[14],
		n41 = te[3], n42 = te[7], n43 = te[11], n44 = te[15];

	return (
		n14 * n23 * n32 * n41-
		n13 * n24 * n32 * n41-
		n14 * n22 * n33 * n41+
		n12 * n24 * n33 * n41+

		n13 * n22 * n34 * n41-
		n12 * n23 * n34 * n41-
		n14 * n23 * n31 * n42+
		n13 * n24 * n31 * n42+

		n14 * n21 * n33 * n42-
		n11 * n24 * n33 * n42-
		n13 * n21 * n34 * n42+
		n11 * n23 * n34 * n42+

		n14 * n22 * n31 * n43-
		n12 * n24 * n31 * n43-
		n14 * n21 * n32 * n43+
		n11 * n24 * n32 * n43+

		n12 * n21 * n34 * n43-
		n11 * n22 * n34 * n43-
		n13 * n22 * n31 * n44+
		n12 * n23 * n31 * n44+

		n13 * n21 * n32 * n44-
		n11 * n23 * n32 * n44-
		n12 * n21 * n33 * n44+
		n11 * n22 * n33 * n44
	);
};
M4[p].multiply = function( a, b ) {
	var ae = a.e,
		be = b.e,
		te = this.e,

		a11 = ae[0], a12 = ae[4], a13 = ae[8], a14 = ae[12],
		a21 = ae[1], a22 = ae[5], a23 = ae[9], a24 = ae[13],
		a31 = ae[2], a32 = ae[6], a33 = ae[10], a34 = ae[14],
		a41 = ae[3], a42 = ae[7], a43 = ae[11], a44 = ae[15],

		b11 = be[0], b12 = be[4], b13 = be[8], b14 = be[12],
		b21 = be[1], b22 = be[5], b23 = be[9], b24 = be[13],
		b31 = be[2], b32 = be[6], b33 = be[10], b34 = be[14],
		b41 = be[3], b42 = be[7], b43 = be[11], b44 = be[15];

	te[0] = a11 * b11 + a12 * b21 + a13 * b31 + a14 * b41;
	te[4] = a11 * b12 + a12 * b22 + a13 * b32 + a14 * b42;
	te[8] = a11 * b13 + a12 * b23 + a13 * b33 + a14 * b43;
	te[12] = a11 * b14 + a12 * b24 + a13 * b34 + a14 * b44;

	te[1] = a21 * b11 + a22 * b21 + a23 * b31 + a24 * b41;
	te[5] = a21 * b12 + a22 * b22 + a23 * b32 + a24 * b42;
	te[9] = a21 * b13 + a22 * b23 + a23 * b33 + a24 * b43;
	te[13] = a21 * b14 + a22 * b24 + a23 * b34 + a24 * b44;

	te[2] = a31 * b11 + a32 * b21 + a33 * b31 + a34 * b41;
	te[6] = a31 * b12 + a32 * b22 + a33 * b32 + a34 * b42;
	te[10] = a31 * b13 + a32 * b23 + a33 * b33 + a34 * b43;
	te[14] = a31 * b14 + a32 * b24 + a33 * b34 + a34 * b44;

	te[3] = a41 * b11 + a42 * b21 + a43 * b31 + a44 * b41;
	te[7] = a41 * b12 + a42 * b22 + a43 * b32 + a44 * b42;
	te[11] = a41 * b13 + a42 * b23 + a43 * b33 + a44 * b43;
	te[15] = a41 * b14 + a42 * b24 + a43 * b34 + a44 * b44;

	return this;
};
M4[p].getMaxScaleOnAxis = function() {
	var te = this.e;

	var tx =  te[0] * te[0] + te[1] * te[1] + te[2] * te[2];
	var ty =  te[4] * te[4] + te[5] * te[5] + te[6] * te[6];
	var tz =  te[8] * te[8] + te[9] * te[9] + te[10] * te[10];

	return sq( Math.max( tx, Math.max( ty, tz ) ) );
};
M4[p].multiplyV3 = function( v ) {
	var te = this.e;

	var vx = v.x, vy = v.y, vz = v.z;
	var d = 1 / ( te[3] * vx + te[7] * vy + te[11] * vz + te[15] );

	v.x = ( te[0] * vx + te[4] * vy + te[8] * vz + te[12] ) * d;
	v.y = ( te[1] * vx + te[5] * vy + te[9] * vz + te[13] ) * d;
	v.z = ( te[2] * vx + te[6] * vy + te[10] * vz + te[14] ) * d;

	return v;
};
M4[p].multiplyV4 = function( v ) {
	var te = this.e;
	var vx = v.x, vy = v.y, vz = v.z, vw = v.w;

	v.x = te[0] * vx + te[4] * vy + te[8] * vz + te[12] * vw;
	v.y = te[1] * vx + te[5] * vy + te[9] * vz + te[13] * vw;
	v.z = te[2] * vx + te[6] * vy + te[10] * vz + te[14] * vw;
	v.w = te[3] * vx + te[7] * vy + te[11] * vz + te[15] * vw;

	return v;
};
M4[p].setPosition = function( v ) {
	var te = this.e;

	te[12] = v.x;
	te[13] = v.y;
	te[14] = v.z;

	return this;
};
var _gp1 = new V3;
M4[p].getPosition = function() {
	var te = this.e;
	return _gp1.set( te[12], te[13], te[14] );
};
M4[p].setRotation = function( v ) {
	var te = this.e;

	var x = v.x, y = v.y, z = v.z;
	var a = Math.cos( x ), b = Math.sin( x );
	var c = Math.cos( y ), d = Math.sin( y );
	var e = Math.cos( z ), f = Math.sin( z );
	
	var ae = a * e, af = a * f, be = b * e, bf = b * f;

	te[0] = c * e;
	te[4] = - c * f;
	te[8] = d;

	te[1] = af + be * d;
	te[5] = ae - bf * d;
	te[9] = - b * c;

	te[2] = bf - ae * d;
	te[6] = be + af * d;
	te[10] = a * c;
	
	return this;
};
M4[p].extractRotation = function( m ) {
	var te = this.e;
	var me = m.e;

	var vector = new V3;

	var scaleX = 1 / vector.set( me[0], me[1], me[2] ).length();
	var scaleY = 1 / vector.set( me[4], me[5], me[6] ).length();
	var scaleZ = 1 / vector.set( me[8], me[9], me[10] ).length();

	te[0] = me[0] * scaleX;
	te[1] = me[1] * scaleX;
	te[2] = me[2] * scaleX;

	te[4] = me[4] * scaleY;
	te[5] = me[5] * scaleY;
	te[6] = me[6] * scaleY;

	te[8] = me[8] * scaleZ;
	te[9] = me[9] * scaleZ;
	te[10] = me[10] * scaleZ;

	return this;
};

//Vector4
V4 = function( x, y, z, w ) {
	this.x = x;
	this.y = y;
	this.z = z;
	this.w = w;
};
V4[p].set = function( x, y, z, w ) {
	this.x = x;
	this.y = y;
	this.z = z;
	this.w = w;
	return this;
};
V4[p].divideScalar = function( s ) {
	if ( s ) {
		this.x /= s;
		this.y /= s;
		this.z /= s;
		this.w /= s;
	} else {
		this.x = 0;
		this.y = 0;
		this.z = 0;
		this.w = 1;
	}
	return this;
};
V4[p].copy = function( v ) {
	this.x = v.x;
	this.y = v.y;
	this.z = v.z;
	this.w = ( v.w !== undefined ) ? v.w : 1;

	return this;
}
V4[p].clone = function( v ){
	return new V4( this.x, this.y, this.z, this.w );
}

//Frustum
FR = function() {
	this.planes = [ new V4, new V4, new V4, new V4, new V4, new V4 ];
};
FR[p].setFromMatrix = function( m ) {
	t1 = this.planes;
	var	me = m.e,
		me0 = me[0], me1 = me[1], me2 = me[2], me3 = me[3],
		me4 = me[4], me5 = me[5], me6 = me[6], me7 = me[7],
		me8 = me[8], me9 = me[9], me10 = me[10], me11 = me[11],
		me12 = me[12], me13 = me[13], me14 = me[14], me15 = me[15];

	t1[ 0 ].set( me3 - me0, me7 - me4, me11 - me8, me15 - me12 );
	t1[ 1 ].set( me3 + me0, me7 + me4, me11 + me8, me15 + me12 );
	t1[ 2 ].set( me3 + me1, me7 + me5, me11 + me9, me15 + me13 );
	t1[ 3 ].set( me3 - me1, me7 - me5, me11 - me9, me15 - me13 );
	t1[ 4 ].set( me3 - me2, me7 - me6, me11 - me10, me15 - me14 );
	t1[ 5 ].set( me3 + me2, me7 + me6, me11 + me10, me15 + me14 );

	for (i1=0;i1<6;i1++){
		t2 = t1[i1];
		t2.divideScalar( sq( t2.x * t2.x + t2.y * t2.y + t2.z * t2.z ) );
	}
};
FR[p].contains = function( o ) {
	t2 = this.planes;
	t3 = o.m.e;

	for ( var i2 = 0; i2 < 6; i2 ++ ) {
		t1 = t2[ i2 ].x * t3[12] + t2[ i2 ].y * t3[13] + t2[ i2 ].z * t3[14] + t2[ i2 ].w;
		if ( t1 <= - o.bs * o.m.getMaxScaleOnAxis() ) return false;
	}

	return true;
};

//Face
F = function( v, m, n ) {
	this.v=v; // list of V3s
	this.m=m; // material (V4)
	this.n=n; // F normal
};
F[p].clone = function() {
	return new F(
		[ this.v[0].clone(), this.v[1].clone(), this.v[2].clone() ],
		this.m.clone(),
		this.n.clone(),
		this.c.clone()
	)
};
F[p].computeW = function() {
	this.w = ( this.v[0].w + this.v[1].w + this.v[2].w ) / 3;
	return this;
};

Geometry = function( v, f ) {
	// vertices
	this.v = [];
	for ( i1 = 0; i1 < v[l]; i1 += 3 ) {
		this.v.push( new V3( v[i1], v[i1+1], v[i1+2] ) );
	}

	// faces
	this.f = [];
	for ( i1 = 0; i1 < f[l]; i1 += 4 ) {
		this.f.push( new F( [f[i1], f[i1+1], f[i1+2]], f[i1+3] ) );
	}

	var i;
	for ( i = 0; i < this.f[l]; i++ ) {
		this.f[i].n = this.v[this.f[i].v[1]].clone().sub( this.v[this.f[i].v[0]] ).cross(
			this.v[this.f[i].v[2]].clone().sub( this.v[this.f[i].v[0]] )
		).normalize();
	}
};

Model = function( g, c ) {
	// materials
	this.c = [];
	for ( i1 = 0; i1 < c[l]; i1 += 4 ) {
		this.c.push( new V4( c[i1], c[i1+1], c[i1+2], c[i1+3] ) );
	}

	this.g = g; // geometry
	this.m = new M4; //matrix
	this.p = new V3; //position
	this.r = new V3; //rotation
	this.t = new V3; //target, used for players
	this.k = []; //children
	this.a = []; //animation sets
	this.ap = []; //animation progress
	this.iv = false; // is visible
};

var ca = document.getElementById('c'), c = ca.getContext('2d'),
b = 640, e = 480, //canvas width, height
w = window,
raf = 'equestAnimationFrame',
a = window['r'+raf] || window['mozR'+raf] || window['webkitR'+raf] || window['oR'+raf] || window['msR'+raf],

cam = {
	p: new M4( [1.6083801984786987,0,0,0,0,2.1445069313049316,0,0,0,0,-1.0002000331878662,-1,0,0,-2.000200033187866,0] ), //projection matrix
	m: new M4( [1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1] ), //world matrix
	i: new M4( [1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1] ), //matrix world inverse
	near: 5,
	far: 500,
	look_at: new V3,
	position: new V3,
	position_target: new V3( -60, 80, 120 ),
	look_at_target: new V3
},

scene_objects=[],
scene_renderables=[],
scene_elements=[],

map = [],

materials = {
	floor_0: [ 35, 30, 25, 1 ],
	floor_1: [ 40, 35, 30, 1 ],
	floor_2: [ 35, 30, 35, 1 ],

	wall_0: [ 80, 70, 70, 1 ],
	wall_1: [ 85, 75, 70, 1 ],
	wall_2: [ 80, 75, 75, 1 ],

	player:    [36,96,3,1,244,29,29,1,227,213,168,1,149,149,149,1,149,149,149,1,12,12,12,1,149,149,149,1,23,36,101,1],
	scientist: [200,210,220,1,244,29,29,1,227,213,168,1,149,149,149,1,149,149,149,1,12,12,12,1,149,149,149,1,200,210,220,1],

	poker: [69,51,32,1]
},

animations = {
	person: [
		// Walking
		[-0.01,0.5,0.04,-0.01,0.5,0.03,0.01,0.07,0.01,-0.01,-0.31,-0.04,-0.01,-0.31,-0.04,-0.11,-0.17,0.12,0.01,0.07,0.01,0,0.12,0,0.01,0.07,0.01,0.01,0.07,0.01,0.01,0.02,0,0.01,0.02,0,0.01,0.07,0.01,-0.02,0.08,1.17,0.12,0.32,0.12,-0.01,0.45,0.14,0.14,0.34,0,-0.01,-0.35,-0.11,-0.01,-0.35,-0.11,-0.01,0.45,0.14,0,0.68,5,0,0.68,5,0,-0.4,5.12,0,-0.4,5.12,0,0.16,-1.02,0,0.17,-1.01,-0.01,0.26,-1,-0.01,0.26,-1,-0.16,-0.1,2.63,-0.22,-0.29,2.58,-0.21,-0.28,2.52,-0.16,-0.09,2.57,0.01,0.09,-0.21,0.01,0.09,-0.21,0.01,0.04,-0.21,0.01,0.04,-0.21,0.06,0.24,1.15,0.06,0.25,1.07,-0.06,-0.01,1.15,-0.05,0.01,1.07,0.01,0.07,0.01,0.01,0.07,0.01,0.01,0.07,0.01,0.01,0.07,0.01,0.01,0.07,0.01,0.01,0.07,0.01,0.01,0.07,0.01,0.01,0.07,0.01,0.01,0.07,0.01,0.01,0.07,0.01,0.01,0.07,0.01,0.01,0.07,0.01,0.01,0.07,0.01,0.01,0.07,0.01,0.01,0.07,0.01,0.01,0.07,0.01,0.01,0.07,0.01,0.01,0.07,0.01,0.01,0.07,0.01,0.01,0.07,0.01,0.01,0.07,0.01,0.01,0.07,0.01,0.01,0.07,0.01,0.01,0.07,0.01,0.01,0.07,0.01,0.01,0.07,0.01,0.01,0.07,0.01,0.01,0.07,0.01,0,-0.4,-5.28,0,0.17,-5.33,0,0.17,-5.33,0,-0.4,-5.28,0,-0.71,2.37,0,-0.71,2.37,0,-0.31,2.46,0,-0.31,2.46,0,0.3,-2.71,0,0.3,-2.71,0,0.74,-2.64,0,0.74,-2.64,0,0.27,4.67,0,0.27,4.67,0,0.55,4.64,0,0.55,4.64,0,-0.44,-5.13,0,-0.44,-5.13,0,-0.18,-5.11,0,-0.18,-5.11],
		// Combat
		[0.06,0,0.07,0.05,0,0.07,0.05,0,0.07,0.06,0,0.07,0.05,0,0.08,0.05,0,0.07,0.05,0,0.07,0.05,0.53,0.27,0.05,0,0.07,0.05,0,0.08,0.05,-0.5,-0.3,0.05,-0.52,-0.28,0.05,0,0.07,0.03,0,1.23,0.05,0,0.07,0.05,0,0.07,0.05,0,0.07,0.05,0,0.08,0.06,0,0.08,0.05,0,0.07,0.06,0,0.07,0.05,0,0.07,0.05,0,0.07,0.06,0,0.07,0.05,2.88,-4.26,0.04,2.9,-4.28,0.04,3.16,-4.05,0.03,3.14,-4.02,0.05,0,0.07,0.05,0,0.07,0.06,0,0.07,0.05,0,0.07,0.06,1.38,-2.02,0.06,1.4,-2.03,0.05,0.87,-2.29,0.06,0.89,-2.3,0.05,0,0.07,0.05,0,0.07,0.05,0,0.07,0.05,0,0.07,0.06,0,0.07,0.05,0,0.07,0.05,0,0.07,0.05,0,0.08,0.06,0,0.07,0.05,0,0.07,0.05,0,0.07,0.05,0,0.07,0.05,0,0.07,0.05,0,0.07,0.05,0,0.07,0.06,0,0.07,0.05,0,0.07,0.05,0,0.07,0.05,0,0.07,0.05,0,0.07,0.05,0,0.08,0.05,0,0.07,0.05,0,0.07,0.05,0,0.08,0.05,0,0.07,0.05,0,0.07,0.05,0,0.07,0.05,0,0.08,0.05,0,0.07,0.05,0,0.08,0.05,0,0.07,0.05,0,0.07,0.05,0,0.07,0.05,0,0.07,0.05,0,0.07,0.05,0,0.07,0.05,0,0.07,0.05,0,0.07,0.05,0,0.07,0.06,0,0.07,0.06,0,0.07,0.05,0,0.07,0.06,0,0.07,0.05,0,0.07,0.06,0,0.07,0.05,0,0.07,0.06,0,0.07,0.05,0,0.07,0.05,0,0.07,0.05,0,0.07,0.05,0,0.07,0.05,0,0.07]
	],
	poker: [
		// Walking
		[0,0.02,0.91,0,-1.49,0.97,0,-1.49,0.97,0,0.02,0.91,0,0.01,0.79,0,0.01,0.79,0,-1.49,0.85,0,-1.49,0.85,0,-2,0.95,0,-2,0.95,0,-2,0.93,0,-2,0.93],
		// Combat
		[0.07,2.77,-2.98,0.07,2.16,-3.04,0.06,2.16,-3.04,0.06,2.77,-2.98,0.07,2.77,-3.03,0.06,2.77,-3.03,0.06,2.17,-3.09,0.07,2.17,-3.09,0.06,1.96,-3.07,0.06,1.96,-3.07,0.06,1.97,-3.08,0.06,1.97,-3.08]
	]
},

models = {
	person: new Geometry(
		[-0.36,6.96,-0.62,-0.96,6.96,-0.62,-1.22,11.3,-0.59,0.37,7.4,-0.58,0.99,7.4,-0.59,-1.31,11.58,-0.65,0.27,11.87,-0.57,1.49,11.47,-0.58,1.24,11.3,-0.59,-0.23,11.87,-0.59,0.89,11.54,0.51,1.47,11.57,0.52,0.24,11.87,0.53,-0.24,11.87,-0.64,-1.53,11.38,0.41,1,6.78,0.32,-0.96,11.36,0.53,-0.96,7.21,0.45,-0.36,7.21,0.45,0.38,6.78,0.33,0.93,-0.03,-1.67,0.51,-0.03,-1.67,0.51,0.34,-3.24,0.93,0.34,-3.24,1.73,7.3,0.29,1.44,7.28,0.29,1.44,7.28,0.03,1.74,7.3,0.03,-1.31,7.56,-1.57,-1.25,7.69,-1.79,-0.97,7.67,-1.73,-1.02,7.54,-1.51,1.63,9.25,-0.1,1.23,9.23,-0.11,1.62,9.3,0.44,1.22,9.27,0.43,-1.51,9.22,-0.29,-1.12,9.2,-0.21,-1.4,9.32,-0.81,-1.01,9.3,-0.73,0.31,13.63,0.41,0.34,13.63,-0.45,-0.31,13.63,-0.47,-0.33,13.63,0.39,0.24,12.05,0.22,-0.25,12.05,0.21,0.26,12.05,-0.26,-0.24,12.05,-0.28,0.34,12.13,0.32,-0.35,12.13,0.3,0.36,12.13,-0.36,-0.34,12.13,-0.38,0.47,12.84,0.71,-0.5,12.84,0.69,0.51,12.84,-0.74,-0.46,12.84,-0.77,-0.32,12.84,-0.77,-0.13,12.84,-0.76,0.24,12.84,-0.75,0.39,12.84,-0.75,0.47,13.1,0.71,-0.5,13.1,0.69,0.51,13.1,-0.74,0.39,13.1,-0.75,-0.46,13.1,-0.77,-0.32,13.1,-0.77,-0.13,13.1,-0.76,0.24,13.1,-0.75,-0.87,0.38,3.43,-0.87,-0.03,1.86,-0.45,-0.03,1.86,-0.45,0.38,3.43,0.93,4.41,-2.32,0.5,4.41,-2.31,0.93,4.08,-1.84,0.5,4.08,-1.84,-0.87,3.79,0.99,-0.45,3.79,0.99,-0.87,3.66,0.43,-0.45,3.66,0.43,0.93,0.63,-2.09,0.51,0.63,-2.09,0.93,0.54,-1.68,0.51,0.54,-1.68,-0.87,1,3.2,-0.45,1,3.2,-0.87,0.77,2.74,-0.45,0.77,2.74],
		[0,1,2,0,3,0,2,0,4,3,2,0,4,2,5,0,6,7,8,0,9,6,8,0,5,9,8,0,4,5,8,0,10,11,12,0,10,12,13,0,10,13,14,0,15,10,14,0,15,14,16,0,16,17,18,0,16,18,19,0,15,16,19,0,20,21,22,1,22,23,20,1,17,16,2,0,2,1,17,0,14,13,9,0,9,5,14,0,24,25,26,2,26,27,24,2,15,4,8,0,8,10,15,0,28,29,30,2,30,31,28,2,8,7,32,0,32,33,8,0,7,11,34,0,34,32,7,0,11,10,35,0,35,34,11,0,10,8,33,3,33,35,10,3,16,14,36,0,36,37,16,0,14,5,38,0,38,36,14,0,5,2,39,0,39,38,5,0,2,16,37,4,37,39,2,4,33,32,27,2,27,26,33,2,32,34,24,2,24,27,32,2,34,35,25,2,25,24,34,2,35,33,26,2,26,25,35,2,37,36,28,2,28,31,37,2,36,38,29,2,29,28,36,2,38,39,30,2,30,29,38,2,39,37,31,2,31,30,39,2,11,7,6,0,6,12,11,0,40,41,42,5,42,43,40,5,13,12,44,2,44,45,13,2,12,6,46,2,46,44,12,2,6,9,47,2,47,46,6,2,9,13,45,2,45,47,9,2,45,44,48,2,48,49,45,2,44,46,50,2,50,48,44,2,46,47,51,2,51,50,46,2,47,45,49,2,49,51,47,2,49,48,52,2,52,53,49,2,48,50,54,2,54,52,48,2,50,51,55,2,50,55,56,2,50,56,57,2,50,57,58,2,50,58,59,2,50,59,54,2,51,49,53,2,53,55,51,2,53,52,60,5,60,61,53,5,52,54,62,5,62,60,52,5,59,63,62,2,62,54,59,2,55,53,61,5,61,64,55,5,61,60,40,5,40,43,61,5,60,62,41,5,41,40,60,5,65,64,42,2,66,65,42,2,67,66,42,2,63,67,42,2,62,63,42,2,62,42,41,2,64,61,43,5,43,42,64,5,55,64,65,2,65,56,55,2,56,65,66,5,66,57,56,5,57,66,67,2,67,58,57,2,58,67,63,5,63,59,58,5,18,0,3,6,3,19,18,6,68,69,70,1,70,71,68,1,3,4,72,7,72,73,3,7,4,15,74,7,74,72,4,7,15,19,75,7,75,74,15,7,19,3,73,7,73,75,19,7,18,17,76,7,76,77,18,7,17,1,78,7,78,76,17,7,1,0,79,7,79,78,1,7,0,18,77,7,77,79,0,7,73,72,80,7,80,81,73,7,72,74,82,7,82,80,72,7,74,75,83,7,83,82,74,7,75,73,81,7,81,83,75,7,77,76,84,7,84,85,77,7,76,78,86,7,86,84,76,7,78,79,87,7,87,86,78,7,79,77,85,7,85,87,79,7,81,80,23,1,23,22,81,1,80,82,20,1,20,23,80,1,82,83,21,1,21,20,82,1,83,81,22,1,22,21,83,1,85,84,68,1,68,71,85,1,84,86,69,1,69,68,84,1,86,87,70,1,70,69,86,1,87,85,71,1,71,70,87,1]
	),
	poker: new Geometry(
		[1.45,7.44,-0.3,1.45,8.05,-3.71,1.63,8.05,-3.71,1.63,7.44,-0.3,1.45,7.72,-0.25,1.63,7.72,-0.25,1.63,8.32,-3.66,1.45,8.32,-3.66,1.56,8.36,-4.86,1.52,8.36,-4.86,1.52,8.42,-4.85,1.56,8.42,-4.85],
		[0,1,2,0,2,3,0,0,4,5,6,0,6,7,4,0,0,3,5,0,5,4,0,0,3,2,6,0,6,5,3,0,8,9,10,0,10,11,8,0,1,0,4,0,4,7,1,0,2,1,9,0,9,8,2,0,1,7,10,0,10,9,1,0,7,6,11,0,11,10,7,0,6,2,8,0,8,11,6,0]
	),
	tile: new Geometry(
			[
				-4.7,0,-4.7,
				4.7,0,-4.7,
				4.7,0,4.7,
				-4.7,0,4.7
			],
			[
				2,1,0,0,
				3,2,0,0
			]
		),
	wall: new Geometry(
			[
				-5,10,-5,
				5,10,-5,
				5,0,-5,
				-5,0,-5
			],
			[
				2,1,0,0,
				3,2,0,0
			]
		)
},

players = [],
player,

// Temporary variables
i1,i2,i3,
t1,t2,t3,
v1 = new V3, v2 = new V3, v3 = new V3, v4 = new V3,
v4_1 = new V4, v4_2 = new V4, v4_3 = new V4,
m1 = new M4,

run = function() {
	ca.addEventListener(
		'click',
		function( ev ) {
			var vector = new V3(
				( (ev.clientX - ca.offsetLeft) / b ) * 2 - 1,
				- ( (ev.clientY - ca.offsetTop) / e ) * 2 + 1,
				.5
			);
			
			var inverse = new M4().getInverse( cam.p ),
				rotator = new M4().multiply( new M4().extractRotation( cam.m ), inverse );
			rotator.multiplyV3( vector );
			vector.normalize();

			vector.multiplyScalar( -cam.m.getPosition().y / vector.y );
			vector.add( cam.m.getPosition().clone() );
			player.t.set( vector.x, .3, vector.z );
		}
	);
	anim();
},
attack = function( who, direction, damage ) {
	v2.set( 0, 0, -1 );
	m1.extractRotation( who.m );
	m1.multiplyV3( v2 );
	v2.multiplyScalar( 10 );
	v2.add( who.p );

	for ( i2 = 0; i2 < players[l]; i2++ ) {
		if ( players[i2].health <= 0 ) { continue };
		if ( players[i2] === who ) { continue };

		v3.copy( players[i2].p ).sub( v2 );
		if ( v3.lengthSq() <= 100 ) {
			players[i2].health -= damage;
			if ( players[i2].health < 0 ) players[i2].health = 0;
			return; // only stab one person at a time
		}
	}
	
},
anim = function() {
	// move players
	player_movement:
	for ( i1 = 0; i1 < players[l]; i1++ ) {

		if ( players[i1].health > 0 ) {

			// direction faced
			v1.copy( players[i1].t ).sub( players[i1].p );

			// if this is an AI person, check for action
			if ( players[i1] !== player ) {
				if (
					player.health > 0
					&&
					v2.copy( player.p ).sub( players[i1].p ).lengthSq() <= 100
					&&
					!players[i1].combat
					) players[i1].combat = .01;
			}

			// Combat animation
			if ( players[i1].combat ) {
				players[i1].combat += .1;
				if ( players[i1].combat >= 2 ) players[i1].combat = 0;
				if ( players[i1].combat >= .4 && players[i1].combat < .5 ) {
					attack( players[i1], v1, 100 );
				}

				players[i1].ap[1] = players[i1].combat;
				if ( players[i1].ap[1] > 1 ) players[i1].ap[1] = 2 - players[i1].ap[1];
				players[i1].k[0].ap[1] = players[i1].ap[1];
			}

			// Walking
			if ( Math.abs( v1.x ) > .2 || Math.abs( v1.z ) > .2 ) {
				// v2 is where the player will be
				v2.copy( players[i1].p )
				v2.x += Math.abs( v1.x ) > .2 ? .3 * (v1.x > 0 ? 1 : -1) : 0;
				v2.z += Math.abs( v1.z ) > .2 ? .3 * (v1.z > 0 ? 1 : -1) : 0;

				// v3 is for collisions
				v3.copy( players[i1].p )
				v3.x += Math.abs( v1.x ) > .2 ? 5 * (v1.x > 0 ? 1 : -1) : 0;
				v3.z += Math.abs( v1.z ) > .2 ? 5 * (v1.z > 0 ? 1 : -1) : 0;

				// Check map bounds
				if (
					v3.x < 0 || v3.z < 0 || v3.x / 10 > map[0][l] - 1 || v3.z / 10 > map[l] - 1 // Map edges
					||
					map[Math.round( v3.z / 10 )][Math.round( v3.x / 10 )] === 0
				) {
					continue;
				}
				

				// Check against player positions
				for ( i2 = 0; i2 < players[l]; i2++ ) {
					if ( players[i2].health <= 0 ) continue;
					if ( players[i1] === players[i2] ) continue;
					v4.copy( v2 ).sub( players[i2].p );
					if ( v4.lengthSq() <= 40 ) continue player_movement;
				}

				players[i1].p.x = v2.x;
				players[i1].p.z = v2.z;
				players[i1].m.lookAt( v2 );
				players[i1].r.getRotationFromMatrix( players[i1].m );
				
				// Walking animation
				if ( !players[i1].a_desc ) {
					players[i1].ap[0] += 0.06;
					if ( players[i1].ap[0] > 1 ) players[i1].a_desc = true;
				} else {
					players[i1].ap[0] -= 0.06;
					if ( players[i1].ap[0] < 0 ) players[i1].a_desc = false;
				}
				//players[i1].k[0].ap[0] = players[i1].ap[0];
			}

		} else if ( players[i1].health === 0 ) {
			players[i1].health = -1;

			// Player has died
			players[i1].ap[0] = players[i1].k[0].ap[0] = .5;
			players[i1].ap[1] = players[i1].k[0].ap[1] = 0;

			players[i1].p.y += .5;
			v2.copy( players[i1].p );
			v2.x += Math.random() * .02 - .01;
			v2.y = 10;
			v2.z += Math.random() * .02 - .01;
			players[i1].m.lookAt( v2 );
			players[i1].r.getRotationFromMatrix( players[i1].m );
		}
	}
	

	// set camera position
	v1.copy( cam.position_target ).sub( cam.position ).multiplyScalar( .02 );
	cam.position.add( v1 );

	v1.copy( cam.look_at_target ).sub( cam.look_at ).multiplyScalar( .02 );
	cam.look_at.add( v1 );

	v1.copy( player.p ).add( cam.position );
	cam.m.setPosition( v1 );

	v1.copy( player.p ).add( cam.look_at );
	cam.m.lookAt( v1 );

	render();
	a( anim ); // rAF loop
},
calculateVisibilty = 0,
projectGraph = function() {
	scene_renderables[l] = 0;
	var o, c;
	
	calculateVisibilty += 1;
	if ( calculateVisibilty == 5 ) calculateVisibilty = 0;

	for ( i1 = 0; i1 < scene_objects[l]; i1++ ){ //loop over all scene objects
		o = scene_objects[i1];
		o.m.setPosition( o.p );
		o.m.setRotation( o.r );
		if( FR.contains( o ) ) {
			if ( calculateVisibilty === 0 ) o.iv = isVisible( player.p, o.p );
			scene_renderables.push( o );
			
			for ( i2 = 0; i2 < o.k[l]; i2++ ) {
				c = o.k[i2];
				c.m.setPosition( c.p );
				c.m.setRotation( c.r );
				c.m.multiply( o.m, c.m );

				c.iv = o.iv;
				scene_renderables.push( c );
			}
		}
	}
},
readyFaces = function() {
	scene_elements[l]=0;
	for( i1 = 0, t1 = scene_renderables[l]; i1 < t1; i1++ ) {

		t2 = scene_renderables[i1];
		m1.extractRotation(t2.m);

		var _vertices = [],
			visible;
		for ( i2 = 0; i2 < t2.g.f[l]; i2++ ) {
			// Move vertex to world position
			v1.copy( t2.g.v[ t2.g.f[i2].v[0] ] );
			v2.copy( t2.g.v[ t2.g.f[i2].v[1] ] );
			v3.copy( t2.g.v[ t2.g.f[i2].v[2] ] );
			
			// Apply animations
			for ( i3 = 0; i3 < t2.a[l]; i3++ ) {
				v4.set(
					t2.a[i3][ t2.g.f[i2].v[0] * 3 ],
					t2.a[i3][ t2.g.f[i2].v[0] * 3 + 1 ],
					t2.a[i3][ t2.g.f[i2].v[0] * 3 + 2 ]
				);
				v1.add( v4.multiplyScalar( t2.ap[i3] ) );

				v4.set(
					t2.a[i3][ t2.g.f[i2].v[1] * 3 ],
					t2.a[i3][ t2.g.f[i2].v[1] * 3 + 1 ],
					t2.a[i3][ t2.g.f[i2].v[1] * 3 + 2 ]
				);
				v2.add( v4.multiplyScalar( t2.ap[i3] ) );

				v4.set(
					t2.a[i3][ t2.g.f[i2].v[2] * 3 ],
					t2.a[i3][ t2.g.f[i2].v[2] * 3 + 1 ],
					t2.a[i3][ t2.g.f[i2].v[2] * 3 + 2 ]
				);
				v3.add( v4.multiplyScalar( t2.ap[i3] ) );
			}

			t2.m.multiplyV3( v1 );
			t2.m.multiplyV3( v2 );
			t2.m.multiplyV3( v3 );

			// Compute screen position
			v4_1.copy( v1 );
			v4_2.copy( v2 );
			v4_3.copy( v3 );

			projectionScreenMatrix.multiplyV4( v4_1 );
			projectionScreenMatrix.multiplyV4( v4_2 );
			projectionScreenMatrix.multiplyV4( v4_3 );

			v4_1.x /= v4_1.w;
			v4_1.y /= v4_1.w;
			//v4_1.visible = v4_1.z > near && v4_1.z < far;
			if ( v4_1.z < cam.near || v4_1.z > cam.far ) continue;
			v4_2.x /= v4_2.w;
			v4_2.y /= v4_2.w;
			if ( v4_1.z < cam.near || v4_1.z > cam.far ) continue;
			//v4_2.visible = v4_2.z > near && v4_2.z < far;
			v4_3.x /= v4_3.w;
			v4_3.y /= v4_3.w;
			if ( v4_1.z < cam.near || v4_1.z > cam.far ) continue;
			//v4_3.visible = v4_3.z > near && v4_3.z < far;

			visible = ( ( v4_3.x - v4_1.x ) * ( v4_2.y - v4_1.y ) - ( v4_3.y - v4_1.y ) * ( v4_2.x - v4_1.x ) ) < 0;

			if (!visible) continue;

			v1.copy( t2.g.f[i2].n );
			m1.multiplyV3( v1 );

			t3 = new F(
				[ v4_1.clone(), v4_2.clone(), v4_3.clone() ],
				t2.c[ t2.g.f[i2].m ],
				v1.clone()
			).computeW();

			t3.vis = t2.iv;
			if ( !t3.vis && t2.a.length > 0 ) continue;

			scene_elements.push( t3 );
		}
	}
}
FSorter = function( a, b ) {
	return b.w - a.w;
},
expand = function( v1, v2 ) {
	// For dealing with canvas anti-aliasing
	var x = v2.x - v1.x, y =  v2.y - v1.y,
	det = x * x + y * y, idet;

	if ( det == 0 ) return;

	idet = 1 / Math.sqrt( det );

	x *= idet; y *= idet;

	v2.x += x; v2.y += y;
	v1.x -= x; v1.y -= y;
},
createPerson = function( type ) {
	var person = new Model(
		models.person,
		materials[type]
	);
	person.ap[0] = 0;
	person.ap[1] = 0;
	person.a = animations.person;

	person.health = 100;

	person.k.push(new Model(
		models.poker,
		materials.poker
	));
	person.k[0].ap[0] = person.k[0].ap[1] = 0;
	person.k[0].a = animations.poker;

	return person;
};
renderElements = function() {
	scene_elements.sort( FSorter );
	for( i1=0, t1 = scene_elements[l]; i1 < t1; i1++ ) {
		t2 = scene_elements[i1];

		t2.v[0].x *= 320; t2.v[0].y *= 240;
		t2.v[0].x += 320; t2.v[0].y += 240;

		t2.v[1].x *= 320; t2.v[1].y *= 240;
		t2.v[1].x += 320; t2.v[1].y += 240;

		t2.v[2].x *= 320; t2.v[2].y *= 240;
		t2.v[2].x += 320; t2.v[2].y += 240;

		var light_normal = new V3( .2,.8,.6 ).normalize();
		var ambient_term = .3;
		light_value = Math.min( Math.max( light_normal.dot( t2.n ), 0 ) + ambient_term, 1 );
		
		// damn antialiasing
		expand( t2.v[0], t2.v[1] );
		expand( t2.v[1], t2.v[2] );
		expand( t2.v[2], t2.v[0] );

		v1.set(
			Math.round( t2.m.x * light_value ),
			Math.round( t2.m.y * light_value ),
			Math.round( t2.m.z * light_value )
		);
		if ( !t2.vis ) v1.multiplyScalar( .2 );

		c.fillStyle = 'rgba(' + Math.round( v1.x ) + ',' + Math.round( v1.y ) + ',' + Math.round( v1.z ) + ',' + t2.m.w + ')';
		c.beginPath();
		c.moveTo(t2.v[0].x,480-t2.v[0].y);
		c.lineTo(t2.v[1].x,480-t2.v[1].y);
		c.lineTo(t2.v[2].x,480-t2.v[2].y);
		c.lineTo(t2.v[0].x,480-t2.v[0].y);
		c.closePath();
		c.fill();
	}
},
isVisible = function( eye, point ) {
	var i1, i2, distance;
	// Walk on the map from eye to point
	v1.copy( point ).sub( eye ); // eye vector
	distance = v1.length();

	if ( distance > 70 ) return false;

	v1.normalize();

	v2.copy( eye ); // v2 holds the current position on the map to check
	for ( i1 = 0; i1 < distance - 1; i1++ ) {
		if (map[ Math.round( v2.z / 10 ) ] !== undefined && map[ Math.round( v2.z / 10 ) ][ Math.round( v2.x / 10 ) ] !== undefined ) {
			if ( map[ Math.round( v2.z / 10 ) ][ Math.round( v2.x / 10 ) ] === 0 ) {
				return false;
			}
		}
		v2.add( v1 );
	}

	return true;
},
FR = new FR,
projectionScreenMatrix = new M4, //projection screen matrix
prepareScene = function() {
	cam.i.getInverse( cam.m );
	projectionScreenMatrix.multiply( cam.p, cam.i );
	FR.setFromMatrix( projectionScreenMatrix );
	projectGraph();
},
render = function() {
	// clear the screen
	c.fillStyle = '#000';
	c.fillRect(0,0,b,e);
	prepareScene();
	readyFaces();
	renderElements();
},
title = function() {
	c.fillStyle = '#000';
	c.fillRect(0,0,b,e);
	c.font = '72pt Comic Sans';
	c.fillStyle = '#44dd77';
	c.fillText( 'Lab 13', 25, 100 );

	var i1, i2, i3, drawRoom = function( x1, y1, x2, y2, options ) {
		options = options || {};

		var person, people = [];

		// Create tiles
		for ( i1 = y1; i1 <= y2; i1++ ) {
			for ( i2 = x1; i2 <= x2; i2++ ) {
				map[i1][i2] = 1;
			}
		}

		// Populate
		if ( options.pmin > 0 && options.pmax ) {
			t1 = Math.floor( Math.random() * (options.pmax - options.pmin + 1) ) + options.pmin;
			for ( i1 = 0; i1 < t1; i1++ ) {
				person = createPerson( 'player' );
				person.p.set(
					( (Math.random() * (x2 - x1)) + x1 ) * 10,
					.3,
					( (Math.random() * (y2 - y1)) + y1 ) * 10
				);
				person.t.set(
					( (Math.random() * (x2 - x1)) + x1 ) * 10,
					.3,
					( (Math.random() * (y2 - y1)) + y1 ) * 10
				);
				players.push( person );
				scene_objects.push( person );
			}
		}

		if ( options.smin > 0 && options.smax ) {
			t1 = Math.floor( Math.random() * (options.smax - options.smin + 1) ) + options.smin;
			for ( i1 = 0; i1 < t1; i1++ ) {
				person = createPerson( 'scientist' );
				person.p.set(
					( (Math.random() * (x2 - x1)) + x1 ) * 10,
					.3,
					( (Math.random() * (y2 - y1)) + y1 ) * 10
				);
				person.t.set(
					( (Math.random() * (x2 - x1)) + x1 ) * 10,
					.3,
					( (Math.random() * (y2 - y1)) + y1 ) * 10
				);
				players.push( person );
				scene_objects.push( person );
			}
		}
	};

	// Generate map
	for ( i1 = 0; i1 < 50; i1++ ) {
		map[i1] = [];
		for ( i2 = 0; i2 < 50; i2++ ) {
			map[i1][i2] = 0;
		}
	}

	drawRoom( 0, 10, 8, 14 );
	drawRoom( 8, 11, 16, 13, {pmin: 1, pmax:4} );

	drawRoom( 11, 10, 12, 10 );
	drawRoom( 10, 6, 14, 9, {pmin: 2, pmax:3} );

	drawRoom( 11, 14, 12, 14 );
	drawRoom( 10, 15, 14, 19, {pmin: 1, pmax:3, smin: 2, smax: 3} );
	
	for ( i1 = 0; i1 < map[0][l]; i1++ ) {
		for ( i2 = 0; i2 < map[l]; i2++ ) {
			// Floor
			switch ( map[i2][i1] ) {
				case 1:
					t1 = new Model( models.tile, materials['floor_' + Math.floor( Math.random() * 3 ) ] );
					t1.p.set( i1 * 10, 0, i2 * 10 );
					scene_objects.push( t1 );
					break;
			}

			// Wall
			if ( map[i2][i1] !== 0 ) {
				if ( map[i2 - 1] === undefined || map[i2 - 1][i1] === 0 ) {
					// Need a wall on top
					t1 = new Model( models.wall, materials['wall_' + Math.floor( Math.random() * 3 ) ] );
					t1.p.set( i1 * 10, 0, i2 * 10 );
					scene_objects.push( t1 );
				}

				if ( map[i2 + 1] === undefined || map[i2 + 1][i1] === 0 ) {
					// Need a wall on bottom
					t1 = new Model( models.wall, materials['wall_' + Math.floor( Math.random() * 3 ) ] );
					t1.p.set( i1 * 10, 0, i2 * 10 );
					t1.r.set( 0, Math.PI, 0 )
					scene_objects.push( t1 );
				}
				
				if ( map[i2][i1 - 1] === undefined || map[i2][i1 - 1] === 0 ) {
					// Need a wall on left
					t1 = new Model( models.wall, materials['wall_' + Math.floor( Math.random() * 3 ) ] );
					t1.p.set( i1 * 10, 0, i2 * 10 );
					t1.r.set( 0, Math.PI / 2, 0 )
					scene_objects.push( t1 );
				}
				
				if ( map[i2][i1 + 1] === undefined || map[i2][i1 + 1] === 0 ) {
					// Need a wall on right
					t1 = new Model( models.wall, materials['wall_' + Math.floor( Math.random() * 3 ) ] );
					t1.p.set( i1 * 10, 0, i2 * 10 );
					t1.r.set( 0, Math.PI / -2, 0 )
					scene_objects.push( t1 );
				}
			}
		}
	}

	player = createPerson( 'player' );
	player.p.set( 30, .3, 120 );
	player.r.y = -Math.PI / 2;
	player.t.copy( player.p );
	players.push( player );
	scene_objects.push( player );
	cam.look_at.set( 20, 5, 0 );
	cam.position.y = 10;

	c.font = '14pt Monospace';
	c.fillText( 'Click to start', 200, 200 );
	document.addEventListener(
		'click',
		function startGame() {
			document.removeEventListener( 'click', startGame );

			document.addEventListener( 'keydown', function( ev ) {
				switch ( ev.keyCode ) {
					case 32: //space
						if ( !player.combat ) player.combat = .01;
						break;
				}
			});

			run();
		}
	);
};
title(); //start everything
</script></body></html>